<!DOCTYPE html>
<html>
<head>
    <title>PEPEGAME</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }
        canvas {
            width: 100vw;
            height: 100vh;
            display: none;
        }
        #startScreen, #characterScreen, #endScreen, #nameScreen {
            position: absolute;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            font-family: 'Press Start 2P', cursive;
        }
        #startScreen { display: flex; }
        #characterScreen { 
            flex-direction: row; 
            justify-content: space-around; 
            align-items: center; 
            display: none; 
        }
        #endScreen, #nameScreen { display: none; }
        #startButton, #submitScore, #rankingButton, #retryButton, .characterButton {
            padding: 20px 40px;
            font-size: 24px;
            background-color: #4CAF50;
            border: none;
            color: white;
            cursor: pointer;
            border-radius: 5px;
            transition: background-color 0.3s;
            font-family: 'Press Start 2P', cursive;
            margin: 10px;
        }
        #startButton:hover, #submitScore:hover, #rankingButton:hover, #retryButton:hover, .characterButton:hover {
            background-color: #45a049;
        }
        #nameInput {
            margin: 20px;
            padding: 10px;
            font-size: 20px;
            font-family: 'Press Start 2P', cursive;
        }
        #ranking, #controls {
            margin-top: 20px;
            text-align: center;
        }
        .characterOption {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .characterImage {
            width: 80px;
            height: 80px;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <canvas id="gameCanvas"></canvas>
    <div id="startScreen">
        <h1>PEPEGAME</h1>
        <button id="startButton">Comenzag</button>
        <div id="controls">
            <p>Controles:</p>
            <p>Flecha Izquierda: Girar izquierda</p>
            <p>Flecha Derecha: Girar derecha</p>
            <p>Flecha Arriba: Avanzar</p>
            <p>Flecha Abajo: Retroceder</p>
            <p>Espacio: Disparar</p>
        </div>
    </div>
    <div id="characterScreen">
        <div class="characterOption">
            <img src="pepe.png" class="characterImage" alt="Pepe">
            <button class="characterButton" data-character="pepe">Pepe</button>
        </div>
        <div class="characterOption">
            <img src="pedro.png" class="characterImage" alt="Pedro">
            <button class="characterButton" data-character="pedro">Pedro</button>
        </div>
        <div class="characterOption">
            <img src="hector.png" class="characterImage" alt="Héctor">
            <button class="characterButton" data-character="hector">Héctor</button>
        </div>
    </div>
    <div id="endScreen">
        <h1>Se tegminó, o la la</h1>
        <p id="scoreText"></p>
        <button id="rankingButton">Ig al ghanking</button>
    </div>
    <div id="nameScreen">
        <h2>Introduce tu nombre</h2>
        <input type="text" id="nameInput" placeholder="Tu nombre" maxlength="10">
        <button id="submitScore">Enviar</button>
        <div id="ranking"></div>
        <button id="retryButton" style="display: none;">Inténtalo otgha vessss</button>
    </div>
    <audio id="backgroundMusicPepe" loop>
        <source src="musica.mp3" type="audio/mp3">
    </audio>
    <audio id="hitSoundPepe">
        <source src="tos.mp3" type="audio/mp3">
    </audio>
    <audio id="backgroundMusicPedro" loop>
        <source src="musica_pedro.mp3" type="audio/mp3">
    </audio>
    <audio id="hitSoundPedro">
        <source src="tos_pedro.mp3" type="audio/mp3">
    </audio>
    <audio id="backgroundMusicHector" loop>
        <source src="musica_hector.mp3" type="audio/mp3">
    </audio>
    <audio id="hitSoundHector">
        <source src="tos_hector.mp3" type="audio/mp3">
    </audio>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <script>
        // Configuración de Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBKgK9OwzGD947pTuXSkf4bEJ70HqGL0Ck",
            authDomain: "pepegame-763c5.firebaseapp.com",
            databaseURL: "https://pepegame-763c5-default-rtdb.firebaseio.com",
            projectId: "pepegame-763c5",
            storageBucket: "pepegame-763c5.firebasestorage.app",
            messagingSenderId: "1084351604949",
            appId: "1:1084351604949:web:cd425714b9b2b825295a5c",
            measurementId: "G-3CFG6X9K0E"
        };

        // Inicializar Firebase
        let db;
        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.database();
            console.log("Firebase inicializado correctamente");
        } catch (error) {
            console.error("Error al inicializar Firebase:", error);
            db = null;
        }

        // Elementos del DOM
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const startScreen = document.getElementById('startScreen');
        const characterScreen = document.getElementById('characterScreen');
        const endScreen = document.getElementById('endScreen');
        const nameScreen = document.getElementById('nameScreen');
        const startButton = document.getElementById('startButton');
        const submitScore = document.getElementById('submitScore');
        const nameInput = document.getElementById('nameInput');
        const scoreText = document.getElementById('scoreText');
        const ranking = document.getElementById('ranking');
        const rankingButton = document.getElementById('rankingButton');
        const retryButton = document.getElementById('retryButton');
        const characterButtons = document.querySelectorAll('.characterButton');

        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        // Recursos por personaje
        const pepeAssets = {
            ship: new Image(),
            bullet: new Image(),
            asteroid: new Image(),
            backgroundMusic: document.getElementById('backgroundMusicPepe'),
            hitSound: document.getElementById('hitSoundPepe')
        };
        pepeAssets.ship.src = 'pepe.png';
        pepeAssets.bullet.src = 'croissant_pepe.png';
        pepeAssets.asteroid.src = 'uk_pepe.jpg';

        const pedroAssets = {
            ship: new Image(),
            bullet: new Image(),
            asteroid: new Image(),
            backgroundMusic: document.getElementById('backgroundMusicPedro'),
            hitSound: document.getElementById('hitSoundPedro')
        };
        pedroAssets.ship.src = 'pedro.png';
        pedroAssets.bullet.src = 'croissant_pedro.png';
        pedroAssets.asteroid.src = 'uk_pedro.png';

        const hectorAssets = {
            ship: new Image(),
            bullet: new Image(),
            asteroid: new Image(),
            backgroundMusic: document.getElementById('backgroundMusicHector'),
            hitSound: document.getElementById('hitSoundHector')
        };
        hectorAssets.ship.src = 'hector.png';
        hectorAssets.bullet.src = 'croissant_hector.png';
        hectorAssets.asteroid.src = 'uk_hector.png';

        // Degradados por personaje
        const pepeGradient = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
        pepeGradient.addColorStop(0, 'blue');
        pepeGradient.addColorStop(0.5, 'white');
        pepeGradient.addColorStop(1, 'red');

        const pedroGradient = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
        pedroGradient.addColorStop(0, '#d3d3d3');
        pedroGradient.addColorStop(0.5, '#e0e0e0');
        pedroGradient.addColorStop(1, '#c0c0c0');

        const hectorGradient = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
        hectorGradient.addColorStop(0, 'yellow');
        hectorGradient.addColorStop(0.25, 'red');
        hectorGradient.addColorStop(0.5, 'yellow');
        hectorGradient.addColorStop(0.75, 'red');
        hectorGradient.addColorStop(1, 'yellow');

        // --- Juego para Pepe ---
        let pepeGameStarted = false;
        let pepeLastShotTime = 0;
        let pepeShip = {
            x: canvas.width / 2,
            y: canvas.height / 2,
            angle: 0,
            speed: 0,
            width: 80,
            height: 80,
            image: pepeAssets.ship
        };
        let pepeBullets = [];
        let pepeAsteroids = [];
        const pepeMaxAsteroids = 5;
        let pepeLives = 3;
        let pepeScore = 0;
        let pepeTimeLeft = 60;
        let pepeLastTime = 0;
        let pepeKeys = {};

        function pepeDrawShip() {
            ctx.save();
            ctx.translate(pepeShip.x, pepeShip.y);
            ctx.rotate(pepeShip.angle);
            ctx.drawImage(pepeShip.image, -pepeShip.width/2, -pepeShip.height/2, pepeShip.width, pepeShip.height);
            ctx.restore();
        }

        function pepeUpdateShip() {
            pepeShip.x += Math.cos(pepeShip.angle) * pepeShip.speed;
            pepeShip.y += Math.sin(pepeShip.angle) * pepeShip.speed;
            if (pepeShip.x < 0) pepeShip.x = canvas.width;
            if (pepeShip.x > canvas.width) pepeShip.x = 0;
            if (pepeShip.y < 0) pepeShip.y = canvas.height;
            if (pepeShip.y > canvas.height) pepeShip.y = 0;
        }

        function pepeCreateBullet(x, y, angle) {
            return {
                x: x,
                y: y,
                angle: angle,
                speed: 10,
                width: 60,
                height: 60,
                image: pepeAssets.bullet
            };
        }

        function pepeDrawBullet(bullet) {
            ctx.save();
            ctx.translate(bullet.x, bullet.y);
            ctx.rotate(bullet.angle);
            ctx.drawImage(bullet.image, -bullet.width/2, -bullet.height/2, bullet.width, bullet.height);
            ctx.restore();
        }

        function pepeUpdateBullet(bullet) {
            bullet.x += Math.cos(bullet.angle) * bullet.speed;
            bullet.y += Math.sin(bullet.angle) * bullet.speed;
        }

        function pepeCreateAsteroid() {
            return {
                x: Math.random() * canvas.width,
                y: Math.random() * canvas.height,
                speedX: (Math.random() - 0.5) * 4,
                speedY: (Math.random() - 0.5) * 4,
                width: 50,
                height: 50,
                image: pepeAssets.asteroid
            };
        }

        function pepeDrawAsteroid(asteroid) {
            ctx.drawImage(asteroid.image, asteroid.x - asteroid.width/2, asteroid.y - asteroid.height/2, asteroid.width, asteroid.height);
        }

        function pepeUpdateAsteroid(asteroid) {
            asteroid.x += asteroid.speedX;
            asteroid.y += asteroid.speedY;
            if (asteroid.x < 0) asteroid.x = canvas.width;
            if (asteroid.x > canvas.width) asteroid.x = 0;
            if (asteroid.y < 0) asteroid.y = canvas.height;
            if (asteroid.y > canvas.height) asteroid.y = 0;
        }

        function pepeDrawLives() {
            const lifeSize = 80;
            ctx.fillStyle = 'black';
            ctx.fillRect(canvas.width - 300, canvas.height - lifeSize - 40, 280, 30);
            ctx.fillStyle = 'yellow';
            ctx.font = '16px "Press Start 2P"';
            ctx.textAlign = 'right';
            ctx.fillText('Vidas ghestantes', canvas.width - 10, canvas.height - lifeSize - 15);
            for (let i = 0; i < pepeLives; i++) {
                ctx.drawImage(pepeAssets.bullet, canvas.width - (lifeSize + 10) * (i + 1), canvas.height - lifeSize - 10, lifeSize, lifeSize);
            }
        }

        function pepeDrawHUD() {
            ctx.font = '16px "Press Start 2P"';
            ctx.textAlign = 'left';
            const puntosText = `Puntos: ${pepeScore}`;
            const puntosWidth = ctx.measureText(puntosText).width;
            ctx.fillStyle = 'black';
            ctx.fillRect(10, 10, puntosWidth + 20, 30);
            const tiempoText = `Tiempo ghestante: ${Math.ceil(pepeTimeLeft)}`;
            const tiempoWidth = ctx.measureText(tiempoText).width;
            ctx.fillStyle = 'black';
            ctx.fillRect(10, 40, tiempoWidth + 20, 30);
            ctx.fillStyle = 'yellow';
            ctx.fillText(puntosText, 20, 30);
            ctx.fillText(tiempoText, 20, 60);
        }

        function pepeGameLoop() {
            if (!pepeGameStarted) return;

            const currentTime = Date.now();
            const deltaTime = (currentTime - pepeLastTime) / 1000;
            pepeLastTime = currentTime;

            pepeTimeLeft -= deltaTime;
            if (pepeTimeLeft <= 0) {
                pepeGameStarted = false;
                canvas.style.display = 'none';
                endScreen.style.display = 'flex';
                scoreText.textContent = `Has ghoto: ${pepeScore}`;
                return;
            }

            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = pepeGradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            if (pepeKeys['ArrowLeft']) {
                console.log("Pepe: Girando izquierda");
                pepeShip.angle -= 0.1;
            }
            if (pepeKeys['ArrowRight']) {
                console.log("Pepe: Girando derecha");
                pepeShip.angle += 0.1;
            }
            if (pepeKeys['ArrowUp']) {
                console.log("Pepe: Avanzando");
                pepeShip.speed = 5;
            }
            if (pepeKeys['ArrowDown']) {
                console.log("Pepe: Retrocediendo");
                pepeShip.speed = -5;
            }
            if (!pepeKeys['ArrowUp'] && !pepeKeys['ArrowDown']) pepeShip.speed = 0;
            if (pepeKeys['Space'] && !pepeKeys['spacePressed'] && (currentTime - pepeLastShotTime) >= 500) {
                console.log("Pepe: Disparando");
                pepeBullets.push(pepeCreateBullet(pepeShip.x, pepeShip.y, pepeShip.angle));
                pepeKeys['spacePressed'] = true;
                pepeLastShotTime = currentTime;
                pepeAssets.hitSound.load();
                pepeAssets.hitSound.play().catch(error => console.log("Error al reproducir sonido de impacto:", error));
            }
            if (!pepeKeys['Space']) pepeKeys['spacePressed'] = false;

            pepeUpdateShip();
            pepeDrawShip();

            pepeBullets = pepeBullets.filter(b => 
                b.x > 0 && b.x < canvas.width && 
                b.y > 0 && b.y < canvas.height
            );
            pepeBullets.forEach(b => {
                pepeUpdateBullet(b);
                pepeDrawBullet(b);
            });

            pepeAsteroids.forEach((a, aIndex) => {
                pepeUpdateAsteroid(a);
                pepeDrawAsteroid(a);

                pepeBullets.forEach((b, bIndex) => {
                    if (Math.hypot(a.x - b.x, a.y - b.y) < a.width/2 + b.width/2) {
                        pepeAssets.hitSound.load();
                        pepeAssets.hitSound.play().catch(error => console.log("Error al reproducir sonido de impacto:", error));
                        createExplosion(a.x, a.y);
                        pepeAsteroids.splice(aIndex, 1);
                        pepeBullets.splice(bIndex, 1);
                        pepeAsteroids.push(pepeCreateAsteroid());
                        pepeScore += 1;
                    }
                });

                if (Math.hypot(a.x - pepeShip.x, a.y - pepeShip.y) < a.width/2 + pepeShip.width/2) {
                    pepeLives -= 1;
                    pepeAssets.hitSound.load();
                    pepeAssets.hitSound.play().catch(error => console.log("Error al reproducir sonido de impacto:", error));
                    createExplosion(pepeShip.x, pepeShip.y);
                    pepeShip.x = canvas.width / 2;
                    pepeShip.y = canvas.height / 2;
                    pepeShip.speed = 0;
                    pepeShip.angle = 0;
                    pepeAsteroids.splice(aIndex, 1);
                    pepeAsteroids.push(pepeCreateAsteroid());
                    if (pepeLives <= 0) {
                        pepeGameStarted = false;
                        canvas.style.display = 'none';
                        endScreen.style.display = 'flex';
                        scoreText.textContent = `Has ghoto: ${pepeScore}`;
                        return;
                    }
                }
            });

            pepeDrawLives();
            pepeDrawHUD();

            requestAnimationFrame(pepeGameLoop);
        }

        function startPepeGame() {
            console.log("Iniciando juego de Pepe");
            pepeGameStarted = true;
            pepeShip = {
                x: canvas.width / 2,
                y: canvas.height / 2,
                angle: 0,
                speed: 0,
                width: 80,
                height: 80,
                image: pepeAssets.ship
            };
            pepeBullets = [];
            pepeAsteroids = [];
            for (let i = 0; i < pepeMaxAsteroids; i++) {
                pepeAsteroids.push(pepeCreateAsteroid());
            }
            pepeLives = 3;
            pepeScore = 0;
            pepeTimeLeft = 60;
            pepeLastTime = Date.now();
            pepeKeys = {};
            // Limpiar eventos anteriores
            document.removeEventListener('keydown', pedroKeyDownHandler);
            document.removeEventListener('keyup', pedroKeyUpHandler);
            document.removeEventListener('keydown', hectorKeyDownHandler);
            document.removeEventListener('keyup', hectorKeyUpHandler);
            // Registrar eventos para Pepe
            document.addEventListener('keydown', pepeKeyDownHandler);
            document.addEventListener('keyup', pepeKeyUpHandler);
            characterScreen.style.display = 'none';
            canvas.style.display = 'block';
            pedroAssets.backgroundMusic.pause();
            hectorAssets.backgroundMusic.pause();
            pepeAssets.backgroundMusic.load();
            pepeAssets.backgroundMusic.play().catch(error => console.log("Error al reproducir música de Pepe:", error));
            pepeGameLoop();
        }

        function pepeKeyDownHandler(e) { 
            pepeKeys[e.code] = true; 
            console.log("Tecla presionada en Pepe:", e.code);
        }
        function pepeKeyUpHandler(e) { 
            pepeKeys[e.code] = false; 
            console.log("Tecla soltada en Pepe:", e.code);
        }

        // --- Juego para Pedro ---
        let pedroGameStarted = false;
        let pedroLastShotTime = 0;
        let pedroShip = {
            x: canvas.width / 2,
            y: canvas.height / 2,
            angle: 0,
            speed: 0,
            width: 80,
            height: 80,
            image: pedroAssets.ship
        };
        let pedroBullets = [];
        let pedroAsteroids = [];
        const pedroMaxAsteroids = 5;
        let pedroLives = 3;
        let pedroScore = 0;
        let pedroTimeLeft = 60;
        let pedroLastTime = 0;
        let pedroKeys = {};

        function pedroDrawShip() {
            ctx.save();
            ctx.translate(pedroShip.x, pedroShip.y);
            ctx.rotate(pedroShip.angle);
            ctx.drawImage(pedroShip.image, -pedroShip.width/2, -pedroShip.height/2, pedroShip.width, pedroShip.height);
            ctx.restore();
        }

        function pedroUpdateShip() {
            pedroShip.x += Math.cos(pedroShip.angle) * pedroShip.speed;
            pedroShip.y += Math.sin(pedroShip.angle) * pedroShip.speed;
            if (pedroShip.x < 0) pedroShip.x = canvas.width;
            if (pedroShip.x > canvas.width) pedroShip.x = 0;
            if (pedroShip.y < 0) pedroShip.y = canvas.height;
            if (pedroShip.y > canvas.height) pedroShip.y = 0;
        }

        function pedroCreateBullet(x, y, angle) {
            return {
                x: x,
                y: y,
                angle: angle,
                speed: 10,
                width: 60,
                height: 60,
                image: pedroAssets.bullet
            };
        }

        function pedroDrawBullet(bullet) {
            ctx.save();
            ctx.translate(bullet.x, bullet.y);
            ctx.rotate(bullet.angle);
            ctx.drawImage(bullet.image, -bullet.width/2, -bullet.height/2, bullet.width, bullet.height);
            ctx.restore();
        }

        function pedroUpdateBullet(bullet) {
            bullet.x += Math.cos(bullet.angle) * bullet.speed;
            bullet.y += Math.sin(bullet.angle) * bullet.speed;
        }

        function pedroCreateAsteroid() {
            return {
                x: Math.random() * canvas.width,
                y: Math.random() * canvas.height,
                speedX: (Math.random() - 0.5) * 4,
                speedY: (Math.random() - 0.5) * 4,
                width: 50,
                height: 50,
                image: pedroAssets.asteroid
            };
        }

        function pedroDrawAsteroid(asteroid) {
            ctx.drawImage(asteroid.image, asteroid.x - asteroid.width/2, asteroid.y - asteroid.height/2, asteroid.width, asteroid.height);
        }

        function pedroUpdateAsteroid(asteroid) {
            asteroid.x += asteroid.speedX;
            asteroid.y += asteroid.speedY;
            if (asteroid.x < 0) asteroid.x = canvas.width;
            if (asteroid.x > canvas.width) asteroid.x = 0;
            if (asteroid.y < 0) asteroid.y = canvas.height;
            if (asteroid.y > canvas.height) asteroid.y = 0;
        }

        function pedroDrawLives() {
            const lifeSize = 80;
            ctx.fillStyle = 'black';
            ctx.fillRect(canvas.width - 300, canvas.height - lifeSize - 40, 280, 30);
            ctx.fillStyle = 'yellow';
            ctx.font = '16px "Press Start 2P"';
            ctx.textAlign = 'right';
            ctx.fillText('Vidas ghestantes', canvas.width - 10, canvas.height - lifeSize - 15);
            for (let i = 0; i < pedroLives; i++) {
                ctx.drawImage(pedroAssets.bullet, canvas.width - (lifeSize + 10) * (i + 1), canvas.height - lifeSize - 10, lifeSize, lifeSize);
            }
        }

        function pedroDrawHUD() {
            ctx.font = '16px "Press Start 2P"';
            ctx.textAlign = 'left';
            const puntosText = `Puntos: ${pedroScore}`;
            const puntosWidth = ctx.measureText(puntosText).width;
            ctx.fillStyle = 'black';
            ctx.fillRect(10, 10, puntosWidth + 20, 30);
            const tiempoText = `Tiempo ghestante: ${Math.ceil(pedroTimeLeft)}`;
            const tiempoWidth = ctx.measureText(tiempoText).width;
            ctx.fillStyle = 'black';
            ctx.fillRect(10, 40, tiempoWidth + 20, 30);
            ctx.fillStyle = 'yellow';
            ctx.fillText(puntosText, 20, 30);
            ctx.fillText(tiempoText, 20, 60);
        }

        function pedroGameLoop() {
            if (!pedroGameStarted) return;

            const currentTime = Date.now();
            const deltaTime = (currentTime - pedroLastTime) / 1000;
            pedroLastTime = currentTime;

            pedroTimeLeft -= deltaTime;
            if (pedroTimeLeft <= 0) {
                pedroGameStarted = false;
                canvas.style.display = 'none';
                endScreen.style.display = 'flex';
                scoreText.textContent = `Has ghoto: ${pedroScore}`;
                return;
            }

            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = pedroGradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            if (pedroKeys['ArrowLeft']) {
                console.log("Pedro: Girando izquierda");
                pedroShip.angle -= 0.1;
            }
            if (pedroKeys['ArrowRight']) {
                console.log("Pedro: Girando derecha");
                pedroShip.angle += 0.1;
            }
            if (pedroKeys['ArrowUp']) {
                console.log("Pedro: Avanzando");
                pedroShip.speed = 5;
            }
            if (pedroKeys['ArrowDown']) {
                console.log("Pedro: Retrocediendo");
                pedroShip.speed = -5;
            }
            if (!pedroKeys['ArrowUp'] && !pedroKeys['ArrowDown']) pedroShip.speed = 0;
            if (pedroKeys['Space'] && !pedroKeys['spacePressed'] && (currentTime - pedroLastShotTime) >= 500) {
                console.log("Pedro: Disparando");
                pedroBullets.push(pedroCreateBullet(pedroShip.x, pedroShip.y, pedroShip.angle));
                pedroKeys['spacePressed'] = true;
                pedroLastShotTime = currentTime;
                pedroAssets.hitSound.load();
                pedroAssets.hitSound.play().catch(error => console.log("Error al reproducir sonido de impacto:", error));
            }
            if (!pedroKeys['Space']) pedroKeys['spacePressed'] = false;

            pedroUpdateShip();
            pedroDrawShip();

            pedroBullets = pedroBullets.filter(b => 
                b.x > 0 && b.x < canvas.width && 
                b.y > 0 && b.y < canvas.height
            );
            pedroBullets.forEach(b => {
                pedroUpdateBullet(b);
                pedroDrawBullet(b);
            });

            pedroAsteroids.forEach((a, aIndex) => {
                pedroUpdateAsteroid(a);
                pedroDrawAsteroid(a);

                pedroBullets.forEach((b, bIndex) => {
                    if (Math.hypot(a.x - b.x, a.y - b.y) < a.width/2 + b.width/2) {
                        pedroAssets.hitSound.load();
                        pedroAssets.hitSound.play().catch(error => console.log("Error al reproducir sonido de impacto:", error));
                        createExplosion(a.x, a.y);
                        pedroAsteroids.splice(aIndex, 1);
                        pedroBullets.splice(bIndex, 1);
                        pedroAsteroids.push(pedroCreateAsteroid());
                        pedroScore += 1;
                    }
                });

                if (Math.hypot(a.x - pedroShip.x, a.y - pedroShip.y) < a.width/2 + pedroShip.width/2) {
                    pedroLives -= 1;
                    pedroAssets.hitSound.load();
                    pedroAssets.hitSound.play().catch(error => console.log("Error al reproducir sonido de impacto:", error));
                    createExplosion(pedroShip.x, pedroShip.y);
                    pedroShip.x = canvas.width / 2;
                    pedroShip.y = canvas.height / 2;
                    pedroShip.speed = 0;
                    pedroShip.angle = 0;
                    pedroAsteroids.splice(aIndex, 1);
                    pedroAsteroids.push(pedroCreateAsteroid());
                    if (pedroLives <= 0) {
                        pedroGameStarted = false;
                        canvas.style.display = 'none';
                        endScreen.style.display = 'flex';
                        scoreText.textContent = `Has ghoto: ${pedroScore}`;
                        return;
                    }
                }
            });

            pedroDrawLives();
            pedroDrawHUD();

            requestAnimationFrame(pedroGameLoop);
        }

        function startPedroGame() {
            console.log("Iniciando juego de Pedro");
            pedroGameStarted = true;
            pedroShip = {
                x: canvas.width / 2,
                y: canvas.height / 2,
                angle: 0,
                speed: 0,
                width: 80,
                height: 80,
                image: pedroAssets.ship
            };
            pedroBullets = [];
            pedroAsteroids = [];
            for (let i = 0; i < pedroMaxAsteroids; i++) {
                pedroAsteroids.push(pedroCreateAsteroid());
            }
            pedroLives = 3;
            pedroScore = 0;
            pedroTimeLeft = 60;
            pedroLastTime = Date.now();
            pedroKeys = {};
            // Limpiar eventos anteriores
            document.removeEventListener('keydown', pepeKeyDownHandler);
            document.removeEventListener('keyup', pepeKeyUpHandler);
            document.removeEventListener('keydown', hectorKeyDownHandler);
            document.removeEventListener('keyup', hectorKeyUpHandler);
            // Registrar eventos para Pedro
            document.addEventListener('keydown', pedroKeyDownHandler);
            document.addEventListener('keyup', pedroKeyUpHandler);
            characterScreen.style.display = 'none';
            canvas.style.display = 'block';
            pepeAssets.backgroundMusic.pause();
            hectorAssets.backgroundMusic.pause();
            pedroAssets.backgroundMusic.load();
            pedroAssets.backgroundMusic.play().catch(error => console.log("Error al reproducir música de Pedro:", error));
            pedroGameLoop();
        }

        function pedroKeyDownHandler(e) { 
            pedroKeys[e.code] = true; 
            console.log("Tecla presionada en Pedro:", e.code);
        }
        function pedroKeyUpHandler(e) { 
            pedroKeys[e.code] = false; 
            console.log("Tecla soltada en Pedro:", e.code);
        }

        // --- Juego para Héctor ---
        let hectorGameStarted = false;
        let hectorLastShotTime = 0;
        let hectorShip = {
            x: canvas.width / 2,
            y: canvas.height / 2,
            angle: 0,
            speed: 0,
            width: 80,
            height: 80,
            image: hectorAssets.ship
        };
        let hectorBullets = [];
        let hectorAsteroids = [];
        const hectorMaxAsteroids = 5;
        let hectorLives = 3;
        let hectorScore = 0;
        let hectorTimeLeft = 60;
        let hectorLastTime = 0;
        let hectorKeys = {};

        function hectorDrawShip() {
            ctx.save();
            ctx.translate(hectorShip.x, hectorShip.y);
            ctx.rotate(hectorShip.angle);
            ctx.drawImage(hectorShip.image, -hectorShip.width/2, -hectorShip.height/2, hectorShip.width, hectorShip.height);
            ctx.restore();
        }

        function hectorUpdateShip() {
            hectorShip.x += Math.cos(hectorShip.angle) * hectorShip.speed;
            hectorShip.y += Math.sin(hectorShip.angle) * hectorShip.speed;
            if (hectorShip.x < 0) hectorShip.x = canvas.width;
            if (hectorShip.x > canvas.width) hectorShip.x = 0;
            if (hectorShip.y < 0) hectorShip.y = canvas.height;
            if (hectorShip.y > canvas.height) hectorShip.y = 0;
        }

        function hectorCreateBullet(x, y, angle) {
            return {
                x: x,
                y: y,
                angle: angle,
                speed: 10,
                width: 60,
                height: 60,
                image: hectorAssets.bullet
            };
        }

        function hectorDrawBullet(bullet) {
            ctx.save();
            ctx.translate(bullet.x, bullet.y);
            ctx.rotate(bullet.angle);
            ctx.drawImage(bullet.image, -bullet.width/2, -bullet.height/2, bullet.width, bullet.height);
            ctx.restore();
        }

        function hectorUpdateBullet(bullet) {
            bullet.x += Math.cos(bullet.angle) * bullet.speed;
            bullet.y += Math.sin(bullet.angle) * bullet.speed;
        }

        function hectorCreateAsteroid() {
            return {
                x: Math.random() * canvas.width,
                y: Math.random() * canvas.height,
                speedX: (Math.random() - 0.5) * 4,
                speedY: (Math.random() - 0.5) * 4,
                width: 50,
                height: 50,
                image: hectorAssets.asteroid
            };
        }

        function hectorDrawAsteroid(asteroid) {
            ctx.drawImage(asteroid.image, asteroid.x - asteroid.width/2, asteroid.y - asteroid.height/2, asteroid.width, asteroid.height);
        }

        function hectorUpdateAsteroid(asteroid) {
            asteroid.x += asteroid.speedX;
            asteroid.y += asteroid.speedY;
            if (asteroid.x < 0) asteroid.x = canvas.width;
            if (asteroid.x > canvas.width) asteroid.x = 0;
            if (asteroid.y < 0) asteroid.y = canvas.height;
            if (asteroid.y > canvas.height) asteroid.y = 0;
        }

        function hectorDrawLives() {
            const lifeSize = 80;
            ctx.fillStyle = 'black';
            ctx.fillRect(canvas.width - 300, canvas.height - lifeSize - 40, 280, 30);
            ctx.fillStyle = 'yellow';
            ctx.font = '16px "Press Start 2P"';
            ctx.textAlign = 'right';
            ctx.fillText('Vidas ghestantes', canvas.width - 10, canvas.height - lifeSize - 15);
            for (let i = 0; i < hectorLives; i++) {
                ctx.drawImage(hectorAssets.bullet, canvas.width - (lifeSize + 10) * (i + 1), canvas.height - lifeSize - 10, lifeSize, lifeSize);
            }
        }

        function hectorDrawHUD() {
            ctx.font = '16px "Press Start 2P"';
            ctx.textAlign = 'left';
            const puntosText = `Puntos: ${hectorScore}`;
            const puntosWidth = ctx.measureText(puntosText).width;
            ctx.fillStyle = 'black';
            ctx.fillRect(10, 10, puntosWidth + 20, 30);
            const tiempoText = `Tiempo ghestante: ${Math.ceil(hectorTimeLeft)}`;
            const tiempoWidth = ctx.measureText(tiempoText).width;
            ctx.fillStyle = 'black';
            ctx.fillRect(10, 40, tiempoWidth + 20, 30);
            ctx.fillStyle = 'yellow';
            ctx.fillText(puntosText, 20, 30);
            ctx.fillText(tiempoText, 20, 60);
        }

        function hectorGameLoop() {
            if (!hectorGameStarted) return;

            const currentTime = Date.now();
            const deltaTime = (currentTime - hectorLastTime) / 1000;
            hectorLastTime = currentTime;

            hectorTimeLeft -= deltaTime;
            if (hectorTimeLeft <= 0) {
                hectorGameStarted = false;
                canvas.style.display = 'none';
                endScreen.style.display = 'flex';
                scoreText.textContent = `Has ghoto: ${hectorScore}`;
                return;
            }

            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = hectorGradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            if (hectorKeys['ArrowLeft']) {
                console.log("Héctor: Girando izquierda");
                hectorShip.angle -= 0.1;
            }
            if (hectorKeys['ArrowRight']) {
                console.log("Héctor: Girando derecha");
                hectorShip.angle += 0.1;
            }
            if (hectorKeys['ArrowUp']) {
                console.log("Héctor: Avanzando");
                hectorShip.speed = 5;
            }
            if (hectorKeys['ArrowDown']) {
                console.log("Héctor: Retrocediendo");
                hectorShip.speed = -5;
            }
            if (!hectorKeys['ArrowUp'] && !hectorKeys['ArrowDown']) hectorShip.speed = 0;
            if (hectorKeys['Space'] && !hectorKeys['spacePressed'] && (currentTime - hectorLastShotTime) >= 500) {
                console.log("Héctor: Disparando");
                hectorBullets.push(hectorCreateBullet(hectorShip.x, hectorShip.y, hectorShip.angle));
                hectorKeys['spacePressed'] = true;
                hectorLastShotTime = currentTime;
                hectorAssets.hitSound.load();
                hectorAssets.hitSound.play().catch(error => console.log("Error al reproducir sonido de impacto:", error));
            }
            if (!hectorKeys['Space']) hectorKeys['spacePressed'] = false;

            hectorUpdateShip();
            hectorDrawShip();

            hectorBullets = hectorBullets.filter(b => 
                b.x > 0 && b.x < canvas.width && 
                b.y > 0 && b.y < canvas.height
            );
            hectorBullets.forEach(b => {
                hectorUpdateBullet(b);
                hectorDrawBullet(b);
            });

            hectorAsteroids.forEach((a, aIndex) => {
                hectorUpdateAsteroid(a);
                hectorDrawAsteroid(a);

                hectorBullets.forEach((b, bIndex) => {
                    if (Math.hypot(a.x - b.x, a.y - b.y) < a.width/2 + b.width/2) {
                        hectorAssets.hitSound.load();
                        hectorAssets.hitSound.play().catch(error => console.log("Error al reproducir sonido de impacto:", error));
                        createExplosion(a.x, a.y);
                        hectorAsteroids.splice(aIndex, 1);
                        hectorBullets.splice(bIndex, 1);
                        hectorAsteroids.push(hectorCreateAsteroid());
                        hectorScore += 1;
                    }
                });

                if (Math.hypot(a.x - hectorShip.x, a.y - hectorShip.y) < a.width/2 + hectorShip.width/2) {
                    hectorLives -= 1;
                    hectorAssets.hitSound.load();
                    hectorAssets.hitSound.play().catch(error => console.log("Error al reproducir sonido de impacto:", error));
                    createExplosion(hectorShip.x, hectorShip.y);
                    hectorShip.x = canvas.width / 2;
                    hectorShip.y = canvas.height / 2;
                    hectorShip.speed = 0;
                    hectorShip.angle = 0;
                    hectorAsteroids.splice(aIndex, 1);
                    hectorAsteroids.push(hectorCreateAsteroid());
                    if (hectorLives <= 0) {
                        hectorGameStarted = false;
                        canvas.style.display = 'none';
                        endScreen.style.display = 'flex';
                        scoreText.textContent = `Has ghoto: ${hectorScore}`;
                        return;
                    }
                }
            });

            hectorDrawLives();
            hectorDrawHUD();

            requestAnimationFrame(hectorGameLoop);
        }

        function startHectorGame() {
            console.log("Iniciando juego de Héctor");
            hectorGameStarted = true;
            hectorShip = {
                x: canvas.width / 2,
                y: canvas.height / 2,
                angle: 0,
                speed: 0,
                width: 80,
                height: 80,
                image: hectorAssets.ship
            };
            hectorBullets = [];
            hectorAsteroids = [];
            for (let i = 0; i < hectorMaxAsteroids; i++) {
                hectorAsteroids.push(hectorCreateAsteroid());
            }
            hectorLives = 3;
            hectorScore = 0;
            hectorTimeLeft = 60;
            hectorLastTime = Date.now();
            hectorKeys = {};
            // Limpiar eventos anteriores
            document.removeEventListener('keydown', pepeKeyDownHandler);
            document.removeEventListener('keyup', pepeKeyUpHandler);
            document.removeEventListener('keydown', pedroKeyDownHandler);
            document.removeEventListener('keyup', pedroKeyUpHandler);
            // Registrar eventos para Héctor
            document.addEventListener('keydown', hectorKeyDownHandler);
            document.addEventListener('keyup', hectorKeyUpHandler);
            characterScreen.style.display = 'none';
            canvas.style.display = 'block';
            pepeAssets.backgroundMusic.pause();
            pedroAssets.backgroundMusic.pause();
            hectorAssets.backgroundMusic.load();
            hectorAssets.backgroundMusic.play().catch(error => console.log("Error al reproducir música de Héctor:", error));
            hectorGameLoop();
        }

        function hectorKeyDownHandler(e) { 
            hectorKeys[e.code] = true; 
            console.log("Tecla presionada en Héctor:", e.code);
        }
        function hectorKeyUpHandler(e) { 
            hectorKeys[e.code] = false; 
            console.log("Tecla soltada en Héctor:", e.code);
        }

        // Funciones comunes
        function createExplosion(x, y) {
            for (let i = 0; i < 20; i++) {
                ctx.fillStyle = `hsl(${Math.random() * 360}, 100%, 50%)`;
                ctx.beginPath();
                ctx.arc(
                    x + (Math.random() - 0.5) * 30,
                    y + (Math.random() - 0.5) * 30,
                    Math.random() * 3,
                    0,
                    Math.PI * 2
                );
                ctx.fill();
            }
        }

        function showCharacterScreen() {
            startScreen.style.display = 'none';
            characterScreen.style.display = 'flex';
        }

        // Registro de eventos
        console.log("Registrando eventos...");
        startButton.addEventListener('click', showCharacterScreen);
        characterButtons.forEach(button => {
            button.addEventListener('click', () => {
                const character = button.getAttribute('data-character');
                console.log("Personaje seleccionado:", character);
                if (character === 'pepe') startPepeGame();
                else if (character === 'pedro') startPedroGame();
                else if (character === 'hector') startHectorGame();
            });
        });
        rankingButton.addEventListener('click', () => {
            endScreen.style.display = 'none';
            nameScreen.style.display = 'flex';
            nameInput.value = '';
            ranking.innerHTML = '';
            retryButton.style.display = 'none';
            loadAndShowRanking();
        });
        submitScore.addEventListener('click', () => {
            const name = nameInput.value.trim();
            if (name) {
                const score = pepeGameStarted ? pepeScore : pedroGameStarted ? pedroScore : hectorScore;
                saveScore(name, score);
                setTimeout(loadAndShowRanking, 500);
            }
        });
        retryButton.addEventListener('click', () => {
            nameScreen.style.display = 'none';
            startScreen.style.display = 'flex';
            pepeGameStarted = false;
            pedroGameStarted = false;
            hectorGameStarted = false;
            pepeAssets.backgroundMusic.pause();
            pedroAssets.backgroundMusic.pause();
            hectorAssets.backgroundMusic.pause();
        });

        // Carga de imágenes
        Promise.all([
            new Promise(resolve => { pepeAssets.ship.onload = resolve; pepeAssets.ship.onerror = () => console.error("Error cargando pepe.png"); }),
            new Promise(resolve => { pepeAssets.bullet.onload = resolve; pepeAssets.bullet.onerror = () => console.error("Error cargando croissant_pepe.png"); }),
            new Promise(resolve => { pepeAssets.asteroid.onload = resolve; pepeAssets.asteroid.onerror = () => console.error("Error cargando uk_pepe.jpg"); }),
            new Promise(resolve => { pedroAssets.ship.onload = resolve; pedroAssets.ship.onerror = () => console.error("Error cargando pedro.png"); }),
            new Promise(resolve => { pedroAssets.bullet.onload = resolve; pedroAssets.bullet.onerror = () => console.error("Error cargando croissant_pedro.png"); }),
            new Promise(resolve => { pedroAssets.asteroid.onload = resolve; pedroAssets.asteroid.onerror = () => console.error("Error cargando uk_pedro.png"); }),
            new Promise(resolve => { hectorAssets.ship.onload = resolve; hectorAssets.ship.onerror = () => console.error("Error cargando hector.png"); }),
            new Promise(resolve => { hectorAssets.bullet.onload = resolve; hectorAssets.bullet.onerror = () => console.error("Error cargando croissant_hector.png"); }),
            new Promise(resolve => { hectorAssets.asteroid.onload = resolve; hectorAssets.asteroid.onerror = () => console.error("Error cargando uk_hector.png"); })
        ]).then(() => {
            console.log("Imágenes cargadas, listo para iniciar.");
        }).catch(error => {
            console.error("Error al cargar imágenes:", error);
        });

        window.addEventListener('resize', () => {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            if (pepeGameStarted) {
                pepeShip.x = canvas.width / 2;
                pepeShip.y = canvas.height / 2;
            } else if (pedroGameStarted) {
                pedroShip.x = canvas.width / 2;
                pedroShip.y = canvas.height / 2;
            } else if (hectorGameStarted) {
                hectorShip.x = canvas.width / 2;
                hectorShip.y = canvas.height / 2;
            }
            pepeGradient.addColorStop(0, 'blue');
            pepeGradient.addColorStop(0.5, 'white');
            pepeGradient.addColorStop(1, 'red');
            pedroGradient.addColorStop(0, '#d3d3d3');
            pedroGradient.addColorStop(0.5, '#e0e0e0');
            pedroGradient.addColorStop(1, '#c0c0c0');
            hectorGradient.addColorStop(0, 'yellow');
            hectorGradient.addColorStop(0.25, 'red');
            hectorGradient.addColorStop(0.5, 'yellow');
            hectorGradient.addColorStop(0.75, 'red');
            hectorGradient.addColorStop(1, 'yellow');
        });

        console.log("Script cargado completamente");
    </script>
</body>
</html>
