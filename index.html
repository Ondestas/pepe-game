<!DOCTYPE html>
<html>
<head>
    <title>PEPEGAME</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            touch-action: none;
        }
        canvas {
            width: 100vw;
            height: 100vh;
            display: none;
        }
        #startScreen, #characterScreen, #endScreen, #nameScreen {
            position: absolute;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            font-family: 'Press Start 2P', cursive;
            z-index: 10;
        }
        #startScreen { display: flex; }
        #characterScreen { 
            flex-direction: row; 
            justify-content: space-around; 
            align-items: center; 
            display: none; 
        }
        #endScreen, #nameScreen { display: none; }
        #startButton, #submitScore, #rankingButton, #retryButton, .characterButton {
            padding: 20px 40px;
            font-size: 24px;
            background-color: #4CAF50;
            border: none;
            color: white;
            cursor: pointer;
            border-radius: 5px;
            transition: background-color 0.3s;
            font-family: 'Press Start 2P', cursive;
            margin: 10px;
        }
        #startButton:hover, #submitScore:hover, #rankingButton:hover, #retryButton:hover, .characterButton:hover {
            background-color: #45a049;
        }
        #nameInput {
            margin: 20px;
            padding: 10px;
            font-size: 20px;
            font-family: 'Press Start 2P', cursive;
        }
        #ranking, #controls {
            margin-top: 20px;
            text-align: center;
        }
        #tempRanking {
            margin-top: 20px;
            color: yellow;
            font-size: 16px;
            font-family: 'Press Start 2P', cursive;
        }
        .characterOption {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .characterImage {
            width: 80px;
            height: 80px;
            margin-bottom: 10px;
        }
        /* Controles táctiles */
        #touchControls {
            position: absolute;
            bottom: 10px;
            left: 10px;
            right: 10px;
            display: none;
            z-index: 5;
            pointer-events: none;
        }
        #joystick {
            position: absolute;
            left: 20px;
            bottom: 20px;
            width: 240px;
            height: 240px;
            background-color: rgba(255, 255, 255, 0.5);
            border: 4px solid white;
            border-radius: 50%;
            pointer-events: auto;
            touch-action: manipulation;
        }
        #joystickKnob {
            position: absolute;
            width: 80px;
            height: 80px;
            background-color: rgba(255, 255, 255, 0.8);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none;
        }
        #fireButton {
            position: absolute;
            right: 20px;
            bottom: 20px;
            width: 240px;
            height: 240px;
            background-color: rgba(255, 0, 0, 0.5);
            border: 4px solid white;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 40px;
            color: white;
            pointer-events: auto;
            touch-action: manipulation;
        }
        #fireButton:active {
            background-color: rgba(255, 0, 0, 0.8);
        }
        /* Responsive para móviles */
        @media (max-width: 768px) {
            #startButton, #submitScore, #rankingButton, #retryButton, .characterButton {
                padding: 15px 30px;
                font-size: 18px;
            }
            #nameInput {
                font-size: 16px;
                padding: 8px;
            }
            .characterImage {
                width: 60px;
                height: 60px;
            }
            #controls p {
                font-size: 14px;
            }
            #touchControls {
                display: flex;
            }
        }
    </style>
</head>
<body>
    <canvas id="gameCanvas"></canvas>
    <div id="startScreen">
        <h1>PEPEGAME</h1>
        <button id="startButton">Comenzag</button>
        <div id="controls">
            <p>Controles:</p>
            <p>Flecha Izquierda: Girar izquierda</p>
            <p>Flecha Derecha: Girar derecha</p>
            <p>Flecha Arriba: Avanzar</p>
            <p>Flecha Abajo: Retroceder</p>
            <p>Espacio: Disparar</p>
            <p>(En móvil usa el joystick y botón de disparo)</p>
        </div>
    </div>
    <div id="characterScreen">
        <div class="characterOption">
            <img src="pepe.png" class="characterImage" alt="Pepe">
            <button class="characterButton" data-character="pepe">Pepe</button>
        </div>
        <div class="characterOption">
            <img src="pedro.png" class="characterImage" alt="Pedro">
            <button class="characterButton" data-character="pedro">Pedro</button>
        </div>
        <div class="characterOption">
            <img src="hector.png" class="characterImage" alt="Héctor">
            <button class="characterButton" data-character="hector">Héctor</button>
        </div>
    </div>
    <div id="endScreen">
        <h1>Se tegminó, o la la</h1>
        <p id="scoreText"></p>
        <button id="rankingButton">Ig al ghanking</button>
    </div>
    <div id="nameScreen">
        <h2>Introduce tu nombre</h2>
        <input type="text" id="nameInput" placeholder="Tu nombre" maxlength="10">
        <button id="submitScore">Enviar</button>
        <div id="ranking"></div>
        <div id="tempRanking"></div>
        <button id="retryButton" style="display: none;">Inténtalo otgha vessss</button>
    </div>
    <!-- Controles táctiles -->
    <div id="touchControls">
        <div id="joystick">
            <div id="joystickKnob"></div>
        </div>
        <div id="fireButton">🔫</div>
    </div>
    <audio id="backgroundMusicPepe" loop>
        <source src="musica.mp3" type="audio/mp3">
    </audio>
    <audio id="hitSoundPepe">
        <source src="tos.mp3" type="audio/mp3">
    </audio>
    <audio id="backgroundMusicPedro" loop>
        <source src="musica_pedro.mp3" type="audio/mp3">
    </audio>
    <audio id="hitSoundPedro">
        <source src="tos_pedro.mp3" type="audio/mp3">
    </audio>
    <audio id="backgroundMusicHector" loop>
        <source src="musica_hector.mp3" type="audio/mp3">
    </audio>
    <audio id="hitSoundHector">
        <source src="tos_hector.mp3" type="audio/mp3">
    </audio>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <script>
        // Configuración de Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBKgK9OwzGD947pTuXSkf4bEJ70HqGL0Ck",
            authDomain: "pepegame-763c5.firebaseapp.com",
            databaseURL: "https://pepegame-763c5-default-rtdb.firebaseio.com",
            projectId: "pepegame-763c5",
            storageBucket: "pepegame-763c5.firebasestorage.app",
            messagingSenderId: "1084351604949",
            appId: "1:1084351604949:web:cd425714b9b2b825295a5c",
            measurementId: "G-3CFG6X9K0E"
        };

        // Inicializar Firebase
        let db;
        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.database();
            console.log("Firebase inicializado correctamente");
        } catch (error) {
            console.error("Error al inicializar Firebase:", error);
            db = null;
        }

        // Elementos del DOM
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const startScreen = document.getElementById('startScreen');
        const characterScreen = document.getElementById('characterScreen');
        const endScreen = document.getElementById('endScreen');
        const nameScreen = document.getElementById('nameScreen');
        const startButton = document.getElementById('startButton');
        const submitScore = document.getElementById('submitScore');
        const nameInput = document.getElementById('nameInput');
        const scoreText = document.getElementById('scoreText');
        const ranking = document.getElementById('ranking');
        const tempRanking = document.getElementById('tempRanking');
        const rankingButton = document.getElementById('rankingButton');
        const retryButton = document.getElementById('retryButton');
        const characterButtons = document.querySelectorAll('.characterButton');
        const touchControls = document.getElementById('touchControls');
        const joystick = document.getElementById('joystick');
        const joystickKnob = document.getElementById('joystickKnob');
        const fireButton = document.getElementById('fireButton');

        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        // Variable global para guardar la puntuación final
        let finalScore = 0;

        // Recursos por personaje
        const pepeAssets = {
            ship: new Image(),
            bullet: new Image(),
            asteroid: new Image(),
            backgroundMusic: document.getElementById('backgroundMusicPepe'),
            hitSound: document.getElementById('hitSoundPepe')
        };
        pepeAssets.ship.src = 'pepe.png';
        pepeAssets.bullet.src = 'croissant_pepe.png';
        pepeAssets.asteroid.src = 'uk_pepe.jpg';

        const pedroAssets = {
            ship: new Image(),
            bullet: new Image(),
            asteroid: new Image(),
            backgroundMusic: document.getElementById('backgroundMusicPedro'),
            hitSound: document.getElementById('hitSoundPedro')
        };
        pedroAssets.ship.src = 'pedro.png';
        pedroAssets.bullet.src = 'croissant_pedro.png';
        pedroAssets.asteroid.src = 'uk_pedro.png';

        const hectorAssets = {
            ship: new Image(),
            bullet: new Image(),
            asteroid: new Image(),
            backgroundMusic: document.getElementById('backgroundMusicHector'),
            hitSound: document.getElementById('hitSoundHector')
        };
        hectorAssets.ship.src = 'hector.png';
        hectorAssets.bullet.src = 'croissant_hector.png';
        hectorAssets.asteroid.src = 'uk_hector.png';

        // Degradados por personaje
        const pepeGradient = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
        pepeGradient.addColorStop(0, 'blue');
        pepeGradient.addColorStop(0.5, 'white');
        pepeGradient.addColorStop(1, 'red');

        const pedroGradient = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
        pedroGradient.addColorStop(0, '#d3d3d3');
        pedroGradient.addColorStop(0.5, '#e0e0e0');
        pedroGradient.addColorStop(1, '#c0c0c0');

        const hectorGradient = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
        hectorGradient.addColorStop(0, 'yellow');
        hectorGradient.addColorStop(0.25, 'red');
        hectorGradient.addColorStop(0.5, 'yellow');
        hectorGradient.addColorStop(0.75, 'red');
        hectorGradient.addColorStop(1, 'yellow');

        // --- Juego para Pepe ---
        let pepeGameStarted = false;
        let pepeLastShotTime = 0;
        let pepeShip = {
            x: canvas.width / 2,
            y: canvas.height / 2,
            angle: 0,
            speed: 0,
            width: 80,
            height: 80,
            image: pepeAssets.ship
        };
        let pepeBullets = [];
        let pepeAsteroids = [];
        const pepeMaxAsteroids = 8;
        let pepeLives = 3;
        let pepeScore = 0;
        let pepeTimeLeft = 60;
        let pepeLastTime = 0;
        let pepeKeys = {};

        function pepeDrawShip() {
            ctx.save();
            ctx.translate(pepeShip.x, pepeShip.y);
            ctx.rotate(pepeShip.angle);
            ctx.drawImage(pepeShip.image, -pepeShip.width/2, -pepeShip.height/2, pepeShip.width, pepeShip.height);
            ctx.restore();
        }

        function pepeUpdateShip() {
            pepeShip.x += Math.cos(pepeShip.angle) * pepeShip.speed;
            pepeShip.y += Math.sin(pepeShip.angle) * pepeShip.speed;
            if (pepeShip.x < 0) pepeShip.x = canvas.width;
            if (pepeShip.x > canvas.width) pepeShip.x = 0;
            if (pepeShip.y < 0) pepeShip.y = canvas.height;
            if (pepeShip.y > canvas.height) pepeShip.y = 0;
        }

        function pepeCreateBullet(x, y, angle) {
            return {
                x: x,
                y: y,
                angle: angle,
                speed: 10,
                width: 60,
                height: 60,
                image: pepeAssets.bullet
            };
        }

        function pepeDrawBullet(bullet) {
            ctx.save();
            ctx.translate(bullet.x, bullet.y);
            ctx.rotate(bullet.angle);
            ctx.drawImage(bullet.image, -bullet.width/2, -bullet.height/2, bullet.width, bullet.height);
            ctx.restore();
        }

        function pepeUpdateBullet(bullet) {
            bullet.x += Math.cos(bullet.angle) * bullet.speed;
            bullet.y += Math.sin(bullet.angle) * bullet.speed;
        }

        function pepeCreateAsteroid() {
            const side = Math.floor(Math.random() * 4);
            let x, y, speedX, speedY;
            switch (side) {
                case 0: x = Math.random() * canvas.width; y = -50; speedX = (Math.random() - 0.5) * 4; speedY = Math.random() * 4 + 1; break;
                case 1: x = canvas.width + 50; y = Math.random() * canvas.height; speedX = -(Math.random() * 4 + 1); speedY = (Math.random() - 0.5) * 4; break;
                case 2: x = Math.random() * canvas.width; y = canvas.height + 50; speedX = (Math.random() - 0.5) * 4; speedY = -(Math.random() * 4 + 1); break;
                case 3: x = -50; y = Math.random() * canvas.height; speedX = Math.random() * 4 + 1; speedY = (Math.random() - 0.5) * 4; break;
            }
            return {
                x: x,
                y: y,
                speedX: speedX,
                speedY: speedY,
                width: 50,
                height: 50,
                image: pepeAssets.asteroid
            };
        }

        function pepeDrawAsteroid(asteroid) {
            ctx.drawImage(asteroid.image, asteroid.x - asteroid.width/2, asteroid.y - asteroid.height/2, asteroid.width, asteroid.height);
        }

        function pepeUpdateAsteroid(asteroid) {
            asteroid.x += asteroid.speedX;
            asteroid.y += asteroid.speedY;
            if (asteroid.x < -50) asteroid.x = canvas.width + 50;
            if (asteroid.x > canvas.width + 50) asteroid.x = -50;
            if (asteroid.y < -50) asteroid.y = canvas.height + 50;
            if (asteroid.y > canvas.height + 50) asteroid.y = -50;
        }

        function pepeDrawLives() {
            const lifeSize = 80;
            ctx.fillStyle = 'black';
            ctx.fillRect(canvas.width - 300, canvas.height - lifeSize - 40, 280, 30);
            ctx.fillStyle = 'yellow';
            ctx.font = '16px "Press Start 2P"';
            ctx.textAlign = 'right';
            ctx.fillText('Vidas ghestantes', canvas.width - 10, canvas.height - lifeSize - 15);
            for (let i = 0; i < pepeLives; i++) {
                ctx.drawImage(pepeAssets.bullet, canvas.width - (lifeSize + 10) * (i + 1), canvas.height - lifeSize - 10, lifeSize, lifeSize);
            }
        }

        function pepeDrawHUD() {
            ctx.font = '16px "Press Start 2P"';
            ctx.textAlign = 'left';
            const puntosText = `Puntos: ${pepeScore}`;
            const puntosWidth = ctx.measureText(puntosText).width;
            ctx.fillStyle = 'black';
            ctx.fillRect(10, 10, puntosWidth + 20, 30);
            const tiempoText = `Tiempo ghestante: ${Math.ceil(pepeTimeLeft)}`;
            const tiempoWidth = ctx.measureText(tiempoText).width;
            ctx.fillStyle = 'black';
            ctx.fillRect(10, 40, tiempoWidth + 20, 30);
            ctx.fillStyle = 'yellow';
            ctx.fillText(puntosText, 20, 30);
            ctx.fillText(tiempoText, 20, 60);
        }

        function pepeGameLoop() {
            if (!pepeGameStarted) return;

            const currentTime = Date.now();
            const deltaTime = (currentTime - pepeLastTime) / 1000;
            pepeLastTime = currentTime;

            pepeTimeLeft -= deltaTime;
            if (pepeTimeLeft <= 0) {
                pepeGameStarted = false;
                finalScore = pepeScore;
                canvas.style.display = 'none';
                endScreen.style.display = 'flex';
                touchControls.style.display = 'none';
                scoreText.textContent = `Has ghoto: ${pepeScore}`;
                console.log("Puntuación final de Pepe:", pepeScore);
                return;
            }

            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = pepeGradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            if (pepeKeys['ArrowLeft']) pepeShip.angle -= 0.1;
            if (pepeKeys['ArrowRight']) pepeShip.angle += 0.1;
            if (pepeKeys['ArrowUp']) pepeShip.speed = 5;
            if (pepeKeys['ArrowDown']) pepeShip.speed = -5;
            if (!pepeKeys['ArrowUp'] && !pepeKeys['ArrowDown']) pepeShip.speed = 0;
            if (pepeKeys['Space'] && !pepeKeys['spacePressed'] && (currentTime - pepeLastShotTime) >= 500) {
                pepeBullets.push(pepeCreateBullet(pepeShip.x, pepeShip.y, pepeShip.angle));
                pepeKeys['spacePressed'] = true;
                pepeLastShotTime = currentTime;
            }
            if (!pepeKeys['Space']) pepeKeys['spacePressed'] = false;

            pepeUpdateShip();
            pepeDrawShip();

            pepeBullets = pepeBullets.filter(b => 
                b.x > 0 && b.x < canvas.width && 
                b.y > 0 && b.y < canvas.height
            );
            pepeBullets.forEach(b => {
                pepeUpdateBullet(b);
                pepeDrawBullet(b);
            });

            pepeAsteroids.forEach((a, aIndex) => {
                pepeUpdateAsteroid(a);
                pepeDrawAsteroid(a);

                pepeBullets.forEach((b, bIndex) => {
                    if (Math.hypot(a.x - b.x, a.y - b.y) < a.width/2 + b.width/2) {
                        pepeAssets.hitSound.load();
                        pepeAssets.hitSound.play().catch(error => console.log("Error al reproducir sonido de impacto:", error));
                        createExplosion(a.x, a.y);
                        pepeAsteroids.splice(aIndex, 1);
                        pepeBullets.splice(bIndex, 1);
                        pepeAsteroids.push(pepeCreateAsteroid());
                        pepeScore += 1;
                    }
                });

                if (Math.hypot(a.x - pepeShip.x, a.y - pepeShip.y) < a.width/2 + pepeShip.width/2) {
                    pepeLives -= 1;
                    pepeAssets.hitSound.load();
                    pepeAssets.hitSound.play().catch(error => console.log("Error al reproducir sonido de impacto:", error));
                    createExplosion(pepeShip.x, pepeShip.y);
                    pepeShip.x = canvas.width / 2;
                    pepeShip.y = canvas.height / 2;
                    pepeShip.speed = 0;
                    pepeShip.angle = 0;
                    pepeAsteroids.splice(aIndex, 1);
                    pepeAsteroids.push(pepeCreateAsteroid());
                    if (pepeLives <= 0) {
                        pepeGameStarted = false;
                        finalScore = pepeScore;
                        canvas.style.display = 'none';
                        endScreen.style.display = 'flex';
                        touchControls.style.display = 'none';
                        scoreText.textContent = `Has ghoto: ${pepeScore}`;
                        console.log("Puntuación final de Pepe:", pepeScore);
                        return;
                    }
                }
            });

            pepeDrawLives();
            pepeDrawHUD();

            requestAnimationFrame(pepeGameLoop);
        }

        function startPepeGame() {
            console.log("Iniciando juego de Pepe");
            pepeGameStarted = true;
            pepeShip = {
                x: canvas.width / 2,
                y: canvas.height / 2,
                angle: 0,
                speed: 0,
                width: 80,
                height: 80,
                image: pepeAssets.ship
            };
            pepeBullets = [];
            pepeAsteroids = [];
            for (let i = 0; i < pepeMaxAsteroids; i++) {
                pepeAsteroids.push(pepeCreateAsteroid());
            }
            pepeLives = 3;
            pepeScore = 0;
            pepeTimeLeft = 60;
            pepeLastTime = Date.now();
            pepeKeys = {};
            scoreSubmitted = false;
            finalScore = 0;
            document.removeEventListener('keydown', pedroKeyDownHandler);
            document.removeEventListener('keyup', pedroKeyUpHandler);
            document.removeEventListener('keydown', hectorKeyDownHandler);
            document.removeEventListener('keyup', hectorKeyUpHandler);
            document.addEventListener('keydown', pepeKeyDownHandler);
            document.addEventListener('keyup', pepeKeyUpHandler);
            characterScreen.style.display = 'none';
            canvas.style.display = 'block';
            touchControls.style.display = 'flex';
            pedroAssets.backgroundMusic.pause();
            hectorAssets.backgroundMusic.pause();
            pepeAssets.backgroundMusic.load();
            pepeAssets.backgroundMusic.play().catch(error => console.log("Error al reproducir música de Pepe:", error));
            pepeGameLoop();
        }

        function pepeKeyDownHandler(e) { 
            pepeKeys[e.code] = true; 
            console.log("Tecla presionada en Pepe:", e.code);
        }
        function pepeKeyUpHandler(e) { 
            pepeKeys[e.code] = false; 
            console.log("Tecla soltada en Pepe:", e.code);
        }

        // --- Juego para Pedro ---
        let pedroGameStarted = false;
        let pedroLastShotTime = 0;
        let pedroShip = {
            x: canvas.width / 2,
            y: canvas.height / 2,
            angle: 0,
            speed: 0,
            width: 80,
            height: 80,
            image: pedroAssets.ship
        };
        let pedroBullets = [];
        let pedroAsteroids = [];
        const pedroMaxAsteroids = 8;
        let pedroLives = 3;
        let pedroScore = 0;
        let pedroTimeLeft = 60;
        let pedroLastTime = 0;
        let pedroKeys = {};

        function pedroDrawShip() {
            ctx.save();
            ctx.translate(pedroShip.x, pedroShip.y);
            ctx.rotate(pedroShip.angle);
            ctx.drawImage(pedroShip.image, -pedroShip.width/2, -pedroShip.height/2, pedroShip.width, pedroShip.height);
            ctx.restore();
        }

        function pedroUpdateShip() {
            pedroShip.x += Math.cos(pedroShip.angle) * pedroShip.speed;
            pedroShip.y += Math.sin(pedroShip.angle) * pedroShip.speed;
            if (pedroShip.x < 0) pedroShip.x = canvas.width;
            if (pedroShip.x > canvas.width) pedroShip.x = 0;
            if (pedroShip.y < 0) pedroShip.y = canvas.height;
            if (pedroShip.y > canvas.height) pedroShip.y = 0;
        }

        function pedroCreateBullet(x, y, angle) {
            return {
                x: x,
                y: y,
                angle: angle,
                speed: 10,
                width: 60,
                height: 60,
                image: pedroAssets.bullet
            };
        }

        function pedroDrawBullet(bullet) {
            ctx.save();
            ctx.translate(bullet.x, bullet.y);
            ctx.rotate(bullet.angle);
            ctx.drawImage(bullet.image, -bullet.width/2, -bullet.height/2, bullet.width, bullet.height);
            ctx.restore();
        }

        function pedroUpdateBullet(bullet) {
            bullet.x += Math.cos(bullet.angle) * bullet.speed;
            bullet.y += Math.sin(bullet.angle) * bullet.speed;
        }

        function pedroCreateAsteroid() {
            const side = Math.floor(Math.random() * 4);
            let x, y, speedX, speedY;
            switch (side) {
                case 0: x = Math.random() * canvas.width; y = -50; speedX = (Math.random() - 0.5) * 4; speedY = Math.random() * 4 + 1; break;
                case 1: x = canvas.width + 50; y = Math.random() * canvas.height; speedX = -(Math.random() * 4 + 1); speedY = (Math.random() - 0.5) * 4; break;
                case 2: x = Math.random() * canvas.width; y = canvas.height + 50; speedX = (Math.random() - 0.5) * 4; speedY = -(Math.random() * 4 + 1); break;
                case 3: x = -50; y = Math.random() * canvas.height; speedX = Math.random() * 4 + 1; speedY = (Math.random() - 0.5) * 4; break;
            }
            return {
                x: x,
                y: y,
                speedX: speedX,
                speedY: speedY,
                width: 50,
                height: 50,
                image: pedroAssets.asteroid
            };
        }

        function pedroDrawAsteroid(asteroid) {
            ctx.drawImage(asteroid.image, asteroid.x - asteroid.width/2, asteroid.y - asteroid.height/2, asteroid.width, asteroid.height);
        }

        function pedroUpdateAsteroid(asteroid) {
            asteroid.x += asteroid.speedX;
            asteroid.y += asteroid.speedY;
            if (asteroid.x < -50) asteroid.x = canvas.width + 50;
            if (asteroid.x > canvas.width + 50) asteroid.x = -50;
            if (asteroid.y < -50) asteroid.y = canvas.height + 50;
            if (asteroid.y > canvas.height + 50) asteroid.y = -50;
        }

        function pedroDrawLives() {
            const lifeSize = 80;
            ctx.fillStyle = 'black';
            ctx.fillRect(canvas.width - 300, canvas.height - lifeSize - 40, 280, 30);
            ctx.fillStyle = 'yellow';
            ctx.font = '16px "Press Start 2P"';
            ctx.textAlign = 'right';
            ctx.fillText('Vidas ghestantes', canvas.width - 10, canvas.height - lifeSize - 15);
            for (let i = 0; i < pedroLives; i++) {
                ctx.drawImage(pedroAssets.bullet, canvas.width - (lifeSize + 10) * (i + 1), canvas.height - lifeSize - 10, lifeSize, lifeSize);
            }
        }

        function pedroDrawHUD() {
            ctx.font = '16px "Press Start 2P"';
            ctx.textAlign = 'left';
            const puntosText = `Puntos: ${pedroScore}`;
            const puntosWidth = ctx.measureText(puntosText).width;
            ctx.fillStyle = 'black';
            ctx.fillRect(10, 10, puntosWidth + 20, 30);
            const tiempoText = `Tiempo ghestante: ${Math.ceil(pedroTimeLeft)}`;
            const tiempoWidth = ctx.measureText(tiempoText).width;
            ctx.fillStyle = 'black';
            ctx.fillRect(10, 40, tiempoWidth + 20, 30);
            ctx.fillStyle = 'yellow';
            ctx.fillText(puntosText, 20, 30);
            ctx.fillText(tiempoText, 20, 60);
        }

        function pedroGameLoop() {
            if (!pedroGameStarted) return;

            const currentTime = Date.now();
            const deltaTime = (currentTime - pedroLastTime) / 1000;
            pedroLastTime = currentTime;

            pedroTimeLeft -= deltaTime;
            if (pedroTimeLeft <= 0) {
                pedroGameStarted = false;
                finalScore = pedroScore;
                canvas.style.display = 'none';
                endScreen.style.display = 'flex';
                touchControls.style.display = 'none';
                scoreText.textContent = `Has ghoto: ${pedroScore}`;
                console.log("Puntuación final de Pedro:", pedroScore);
                return;
            }

            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = pedroGradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            if (pedroKeys['ArrowLeft']) pedroShip.angle -= 0.1;
            if (pedroKeys['ArrowRight']) pedroShip.angle += 0.1;
            if (pedroKeys['ArrowUp']) pedroShip.speed = 5;
            if (pedroKeys['ArrowDown']) pedroShip.speed = -5;
            if (!pedroKeys['ArrowUp'] && !pedroKeys['ArrowDown']) pedroShip.speed = 0;
            if (pedroKeys['Space'] && !pedroKeys['spacePressed'] && (currentTime - pedroLastShotTime) >= 500) {
                pedroBullets.push(pedroCreateBullet(pedroShip.x, pedroShip.y, pedroShip.angle));
                pedroKeys['spacePressed'] = true;
                pedroLastShotTime = currentTime;
            }
            if (!pedroKeys['Space']) pedroKeys['spacePressed'] = false;

            pedroUpdateShip();
            pedroDrawShip();

            pedroBullets = pedroBullets.filter(b => 
                b.x > 0 && b.x < canvas.width && 
                b.y > 0 && b.y < canvas.height
            );
            pedroBullets.forEach(b => {
                pedroUpdateBullet(b);
                pedroDrawBullet(b);
            });

            pedroAsteroids.forEach((a, aIndex) => {
                pedroUpdateAsteroid(a);
                pedroDrawAsteroid(a);

                pedroBullets.forEach((b, bIndex) => {
                    if (Math.hypot(a.x - b.x, a.y - b.y) < a.width/2 + b.width/2) {
                        pedroAssets.hitSound.load();
                        pedroAssets.hitSound.play().catch(error => console.log("Error al reproducir sonido de impacto:", error));
                        createExplosion(a.x, a.y);
                        pedroAsteroids.splice(aIndex, 1);
                        pedroBullets.splice(bIndex, 1);
                        pedroAsteroids.push(pedroCreateAsteroid());
                        pedroScore += 1;
                    }
                });

                if (Math.hypot(a.x - pedroShip.x, a.y - pedroShip.y) < a.width/2 + pedroShip.width/2) {
                    pedroLives -= 1;
                    pedroAssets.hitSound.load();
                    pedroAssets.hitSound.play().catch(error => console.log("Error al reproducir sonido de impacto:", error));
                    createExplosion(pedroShip.x, pedroShip.y);
                    pedroShip.x = canvas.width / 2;
                    pedroShip.y = canvas.height / 2;
                    pedroShip.speed = 0;
                    pedroShip.angle = 0;
                    pedroAsteroids.splice(aIndex, 1);
                    pedroAsteroids.push(pedroCreateAsteroid());
                    if (pedroLives <= 0) {
                        pedroGameStarted = false;
                        finalScore = pedroScore;
                        canvas.style.display = 'none';
                        endScreen.style.display = 'flex';
                        touchControls.style.display = 'none';
                        scoreText.textContent = `Has ghoto: ${pedroScore}`;
                        console.log("Puntuación final de Pedro:", pedroScore);
                        return;
                    }
                }
            });

            pedroDrawLives();
            pedroDrawHUD();

            requestAnimationFrame(pedroGameLoop);
        }

        function startPedroGame() {
            console.log("Iniciando juego de Pedro");
            pedroGameStarted = true;
            pedroShip = {
                x: canvas.width / 2,
                y: canvas.height / 2,
                angle: 0,
                speed: 0,
                width: 80,
                height: 80,
                image: pedroAssets.ship
            };
            pedroBullets = [];
            pedroAsteroids = [];
            for (let i = 0; i < pedroMaxAsteroids; i++) {
                pedroAsteroids.push(pedroCreateAsteroid());
            }
            pedroLives = 3;
            pedroScore = 0;
            pedroTimeLeft = 60;
            pedroLastTime = Date.now();
            pedroKeys = {};
            scoreSubmitted = false;
            finalScore = 0;
            document.removeEventListener('keydown', pepeKeyDownHandler);
            document.removeEventListener('keyup', pepeKeyUpHandler);
            document.removeEventListener('keydown', hectorKeyDownHandler);
            document.removeEventListener('keyup', hectorKeyUpHandler);
            document.addEventListener('keydown', pedroKeyDownHandler);
            document.addEventListener('keyup', pedroKeyUpHandler);
            characterScreen.style.display = 'none';
            canvas.style.display = 'block';
            touchControls.style.display = 'flex';
            pepeAssets.backgroundMusic.pause();
            hectorAssets.backgroundMusic.pause();
            pedroAssets.backgroundMusic.load();
            pedroAssets.backgroundMusic.play().catch(error => console.log("Error al reproducir música de Pedro:", error));
            pedroGameLoop();
        }

        function pedroKeyDownHandler(e) { 
            pedroKeys[e.code] = true; 
            console.log("Tecla presionada en Pedro:", e.code);
        }
        function pedroKeyUpHandler(e) { 
            pedroKeys[e.code] = false; 
            console.log("Tecla soltada en Pedro:", e.code);
        }

        // --- Juego para Héctor ---
        let hectorGameStarted = false;
        let hectorLastShotTime = 0;
        let hectorShip = {
            x: canvas.width / 2,
            y: canvas.height / 2,
            angle: 0,
            speed: 0,
            width: 80,
            height: 80,
            image: hectorAssets.ship
        };
        let hectorBullets = [];
        let hectorAsteroids = [];
        const hectorMaxAsteroids = 8;
        let hectorLives = 3;
        let hectorScore = 0;
        let hectorTimeLeft = 60;
        let hectorLastTime = 0;
        let hectorKeys = {};

        function hectorDrawShip() {
            ctx.save();
            ctx.translate(hectorShip.x, hectorShip.y);
            ctx.rotate(hectorShip.angle);
            ctx.drawImage(hectorShip.image, -hectorShip.width/2, -hectorShip.height/2, hectorShip.width, hectorShip.height);
            ctx.restore();
        }

        function hectorUpdateShip() {
            hectorShip.x += Math.cos(hectorShip.angle) * hectorShip.speed;
            hectorShip.y += Math.sin(hectorShip.angle) * hectorShip.speed;
            if (hectorShip.x < 0) hectorShip.x = canvas.width;
            if (hectorShip.x > canvas.width) hectorShip.x = 0;
            if (hectorShip.y < 0) hectorShip.y = canvas.height;
            if (hectorShip.y > canvas.height) hectorShip.y = 0;
        }

        function hectorCreateBullet(x, y, angle) {
            return {
                x: x,
                y: y,
                angle: angle,
                speed: 10,
                width: 60,
                height: 60,
                image: hectorAssets.bullet
            };
        }

        function hectorDrawBullet(bullet) {
            ctx.save();
            ctx.translate(bullet.x, bullet.y);
            ctx.rotate(bullet.angle);
            ctx.drawImage(bullet.image, -bullet.width/2, -bullet.height/2, bullet.width, bullet.height);
            ctx.restore();
        }

        function hectorUpdateBullet(bullet) {
            bullet.x += Math.cos(bullet.angle) * bullet.speed;
            bullet.y += Math.sin(bullet.angle) * bullet.speed;
        }

        function hectorCreateAsteroid() {
            const side = Math.floor(Math.random() * 4);
            let x, y, speedX, speedY;
            switch (side) {
                case 0: x = Math.random() * canvas.width; y = -50; speedX = (Math.random() - 0.5) * 4; speedY = Math.random() * 4 + 1; break;
                case 1: x = canvas.width + 50; y = Math.random() * canvas.height; speedX = -(Math.random() * 4 + 1); speedY = (Math.random() - 0.5) * 4; break;
                case 2: x = Math.random() * canvas.width; y = canvas.height + 50; speedX = (Math.random() - 0.5) * 4; speedY = -(Math.random() * 4 + 1); break;
                case 3: x = -50; y = Math.random() * canvas.height; speedX = Math.random() * 4 + 1; speedY = (Math.random() - 0.5) * 4; break;
            }
            return {
                x: x,
                y: y,
                speedX: speedX,
                speedY: speedY,
                width: 50,
                height: 50,
                image: hectorAssets.asteroid
            };
        }

        function hectorDrawAsteroid(asteroid) {
            ctx.drawImage(asteroid.image, asteroid.x - asteroid.width/2, asteroid.y - asteroid.height/2, asteroid.width, asteroid.height);
        }

        function hectorUpdateAsteroid(asteroid) {
            asteroid.x += asteroid.speedX;
            asteroid.y += asteroid.speedY;
            if (asteroid.x < -50) asteroid.x = canvas.width + 50;
            if (asteroid.x > canvas.width + 50) asteroid.x = -50;
            if (asteroid.y < -50) asteroid.y = canvas.height + 50;
            if (asteroid.y > canvas.height + 50) asteroid.y = -50;
        }

        function hectorDrawLives() {
            const lifeSize = 80;
            ctx.fillStyle = 'black';
            ctx.fillRect(canvas.width - 300, canvas.height - lifeSize - 40, 280, 30);
            ctx.fillStyle = 'yellow';
            ctx.font = '16px "Press Start 2P"';
            ctx.textAlign = 'right';
            ctx.fillText('Vidas ghestantes', canvas.width - 10, canvas.height - lifeSize - 15);
            for (let i = 0; i < hectorLives; i++) {
                ctx.drawImage(hectorAssets.bullet, canvas.width - (lifeSize + 10) * (i + 1), canvas.height - lifeSize - 10, lifeSize, lifeSize);
            }
        }

        function hectorDrawHUD() {
            ctx.font = '16px "Press Start 2P"';
            ctx.textAlign = 'left';
            const puntosText = `Puntos: ${hectorScore}`;
            const puntosWidth = ctx.measureText(puntosText).width;
            ctx.fillStyle = 'black';
            ctx.fillRect(10, 10, puntosWidth + 20, 30);
            const tiempoText = `Tiempo ghestante: ${Math.ceil(hectorTimeLeft)}`;
            const tiempoWidth = ctx.measureText(tiempoText).width;
            ctx.fillStyle = 'black';
            ctx.fillRect(10, 40, tiempoWidth + 20, 30);
            ctx.fillStyle = 'yellow';
            ctx.fillText(puntosText, 20, 30);
            ctx.fillText(tiempoText, 20, 60);
        }

        function hectorGameLoop() {
            if (!hectorGameStarted) return;

            const currentTime = Date.now();
            const deltaTime = (currentTime - hectorLastTime) / 1000;
            hectorLastTime = currentTime;

            hectorTimeLeft -= deltaTime;
            if (hectorTimeLeft <= 0) {
                hectorGameStarted = false;
                finalScore = hectorScore;
                canvas.style.display = 'none';
                endScreen.style.display = 'flex';
                touchControls.style.display = 'none';
                scoreText.textContent = `Has ghoto: ${hectorScore}`;
                console.log("Puntuación final de Héctor:", hectorScore);
                return;
            }

            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = hectorGradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            if (hectorKeys['ArrowLeft']) hectorShip.angle -= 0.1;
            if (hectorKeys['ArrowRight']) hectorShip.angle += 0.1;
            if (hectorKeys['ArrowUp']) hectorShip.speed = 5;
            if (hectorKeys['ArrowDown']) hectorShip.speed = -5;
            if (!hectorKeys['ArrowUp'] && !hectorKeys['ArrowDown']) hectorShip.speed = 0;
            if (hectorKeys['Space'] && !hectorKeys['spacePressed'] && (currentTime - hectorLastShotTime) >= 500) {
                hectorBullets.push(hectorCreateBullet(hectorShip.x, hectorShip.y, hectorShip.angle));
                hectorKeys['spacePressed'] = true;
                hectorLastShotTime = currentTime;
            }
            if (!hectorKeys['Space']) hectorKeys['spacePressed'] = false;

            hectorUpdateShip();
            hectorDrawShip();

            hectorBullets = hectorBullets.filter(b => 
                b.x > 0 && b.x < canvas.width && 
                b.y > 0 && b.y < canvas.height
            );
            hectorBullets.forEach(b => {
                hectorUpdateBullet(b);
                hectorDrawBullet(b);
            });

            hectorAsteroids.forEach((a, aIndex) => {
                hectorUpdateAsteroid(a);
                hectorDrawAsteroid(a);

                hectorBullets.forEach((b, bIndex) => {
                    if (Math.hypot(a.x - b.x, a.y - b.y) < a.width/2 + b.width/2) {
                        hectorAssets.hitSound.load();
                        hectorAssets.hitSound.play().catch(error => console.log("Error al reproducir sonido de impacto:", error));
                        createExplosion(a.x, a.y);
                        hectorAsteroids.splice(aIndex, 1);
                        hectorBullets.splice(bIndex, 1);
                        hectorAsteroids.push(hectorCreateAsteroid());
                        hectorScore += 1;
                    }
                });

                if (Math.hypot(a.x - hectorShip.x, a.y - hectorShip.y) < a.width/2 + hectorShip.width/2) {
                    hectorLives -= 1;
                    hectorAssets.hitSound.load();
                    hectorAssets.hitSound.play().catch(error => console.log("Error al reproducir sonido de impacto:", error));
                    createExplosion(hectorShip.x, hectorShip.y);
                    hectorShip.x = canvas.width / 2;
                    hectorShip.y = canvas.height / 2;
                    hectorShip.speed = 0;
                    hectorShip.angle = 0;
                    hectorAsteroids.splice(aIndex, 1);
                    hectorAsteroids.push(hectorCreateAsteroid());
                    if (hectorLives <= 0) {
                        hectorGameStarted = false;
                        finalScore = hectorScore;
                        canvas.style.display = 'none';
                        endScreen.style.display = 'flex';
                        touchControls.style.display = 'none';
                        scoreText.textContent = `Has ghoto: ${hectorScore}`;
                        console.log("Puntuación final de Héctor:", hectorScore);
                        return;
                    }
                }
            });

            hectorDrawLives();
            hectorDrawHUD();

            requestAnimationFrame(hectorGameLoop);
        }

        function startHectorGame() {
            console.log("Iniciando juego de Héctor");
            hectorGameStarted = true;
            hectorShip = {
                x: canvas.width / 2,
                y: canvas.height / 2,
                angle: 0,
                speed: 0,
                width: 80,
                height: 80,
                image: hectorAssets.ship
            };
            hectorBullets = [];
            hectorAsteroids = [];
            for (let i = 0; i < hectorMaxAsteroids; i++) {
                hectorAsteroids.push(hectorCreateAsteroid());
            }
            hectorLives = 3;
            hectorScore = 0;
            hectorTimeLeft = 60;
            hectorLastTime = Date.now();
            hectorKeys = {};
            scoreSubmitted = false;
            finalScore = 0;
            document.removeEventListener('keydown', pepeKeyDownHandler);
            document.removeEventListener('keyup', pepeKeyUpHandler);
            document.removeEventListener('keydown', pedroKeyDownHandler);
            document.removeEventListener('keyup', pedroKeyUpHandler);
            document.addEventListener('keydown', hectorKeyDownHandler);
            document.addEventListener('keyup', hectorKeyUpHandler);
            characterScreen.style.display = 'none';
            canvas.style.display = 'block';
            touchControls.style.display = 'flex';
            pepeAssets.backgroundMusic.pause();
            pedroAssets.backgroundMusic.pause();
            hectorAssets.backgroundMusic.load();
            hectorAssets.backgroundMusic.play().catch(error => console.log("Error al reproducir música de Héctor:", error));
            hectorGameLoop();
        }

        function hectorKeyDownHandler(e) { 
            hectorKeys[e.code] = true; 
            console.log("Tecla presionada en Héctor:", e.code);
        }
        function hectorKeyUpHandler(e) { 
            hectorKeys[e.code] = false; 
            console.log("Tecla soltada en Héctor:", e.code);
        }

        // Funciones comunes
        function createExplosion(x, y) {
            for (let i = 0; i < 20; i++) {
                ctx.fillStyle = `hsl(${Math.random() * 360}, 100%, 50%)`;
                ctx.beginPath();
                ctx.arc(
                    x + (Math.random() - 0.5) * 30,
                    y + (Math.random() - 0.5) * 30,
                    Math.random() * 3,
                    0,
                    Math.PI * 2
                );
                ctx.fill();
            }
        }

        function saveScore(name, score) {
            if (!db) {
                console.warn("Firebase no disponible, puntuación no guardada");
                return;
            }
            const newScore = { name, score, timestamp: Date.now() };
            db.ref('scores').push(newScore).then(() => {
                console.log("Puntuación guardada:", newScore);
            }).catch(error => {
                console.error("Error al guardar puntuación:", error);
            });
        }

        function loadAndShowRanking(userName, userScore) {
            if (!db) {
                console.warn("Firebase no disponible, no se puede cargar el ranking");
                ranking.innerHTML = '<h2>Ranking</h2><p>No disponible</p>';
                retryButton.style.display = 'block';
                return;
            }
            db.ref('scores').orderByChild('score').once('value', (snapshot) => {
                const scores = [];
                snapshot.forEach(child => {
                    scores.push(child.val());
                });
                scores.sort((a, b) => b.score - a.score);

                const top8 = scores.slice(0, 8);
                ranking.innerHTML = '<h2>Ranking</h2>' + top8.map((s, i) => 
                    `<p>${i + 1}. ${s.name}: ${s.score}</p>`).join('');
                
                const allScores = scores.slice();
                const userEntry = { name: userName, score: userScore };
                allScores.push(userEntry);
                allScores.sort((a, b) => b.score - a.score);
                const userPosition = allScores.findIndex(s => s.name === userName && s.score === userScore) + 1;

                if (userPosition > 8) {
                    tempRanking.innerHTML = `<p>${userPosition}. ${userName}: ${userScore}</p>`;
                    setTimeout(() => {
                        tempRanking.innerHTML = '';
                    }, 5000);
                }

                retryButton.style.display = 'block';
            }).catch(error => {
                console.error("Error al cargar ranking:", error);
                ranking.innerHTML = '<h2>Ranking</h2><p>Error al cargar</p>';
                retryButton.style.display = 'block';
            });
        }

        function showCharacterScreen() {
            startScreen.style.display = 'none';
            characterScreen.style.display = 'flex';
        }

        // Control para evitar múltiples envíos en la misma partida
        let scoreSubmitted = false;

        // Registro de eventos
        console.log("Registrando eventos...");
        startButton.addEventListener('click', showCharacterScreen);
        characterButtons.forEach(button => {
            button.addEventListener('click', () => {
                const character = button.getAttribute('data-character');
                console.log("Personaje seleccionado:", character);
                if (character === 'pepe') startPepeGame();
                else if (character === 'pedro') startPedroGame();
                else if (character === 'hector') startHectorGame();
            });
        });
        rankingButton.addEventListener('click', () => {
            endScreen.style.display = 'none';
            nameScreen.style.display = 'flex';
            nameInput.value = '';
            ranking.innerHTML = '';
            tempRanking.innerHTML = '';
            retryButton.style.display = 'none';
            nameInput.disabled = false;
            submitScore.disabled = false;
            nameInput.style.display = 'block';
            submitScore.style.display = 'block';
            console.log("Puntuación actual antes de ranking - Final Score:", finalScore);
        });
        submitScore.addEventListener('click', () => {
            console.log("Botón Enviar clicado");
            if (scoreSubmitted) {
                console.log("Puntuación ya enviada en esta partida, no se permite más envíos");
                return;
            }
            const name = nameInput.value.trim();
            if (name) {
                const score = finalScore;
                console.log("Puntuación enviada al ranking:", score);

                db.ref('scores').orderByChild('score').limitToLast(8).once('value', (snapshot) => {
                    const scores = [];
                    snapshot.forEach(child => {
                        scores.push(child.val());
                    });
                    scores.sort((a, b) => b.score - a.score);
                    const minTop8Score = scores.length < 8 ? 0 : scores[scores.length - 1].score;

                    if (score > minTop8Score || scores.length < 8) {
                        saveScore(name, score);
                    } else {
                        console.log("Puntuación no entra en el top 8, no se guarda permanentemente");
                    }

                    scoreSubmitted = true;
                    nameInput.disabled = true;
                    submitScore.disabled = true;
                    nameInput.style.display = 'none';
                    submitScore.style.display = 'none';
                    setTimeout(() => {
                        loadAndShowRanking(name, score);
                    }, 500);
                }).catch(error => {
                    console.error("Error al verificar top 8:", error);
                    ranking.innerHTML = '<h2>Ranking</h2><p>Error al cargar</p>';
                    retryButton.style.display = 'block';
                });
            } else {
                console.log("Nombre vacío, no se envía");
            }
        });
        retryButton.addEventListener('click', () => {
            nameScreen.style.display = 'none';
            startScreen.style.display = 'flex';
            pepeGameStarted = false;
            pedroGameStarted = false;
            hectorGameStarted = false;
            pepeAssets.backgroundMusic.pause();
            pedroAssets.backgroundMusic.pause();
            hectorAssets.backgroundMusic.pause();
            scoreSubmitted = false;
            finalScore = 0;
        });

        // Joystick y botón de disparo
        let joystickActive = false;
        const joystickCenterX = 20 + 120; // Centro del joystick (left + width/2)
        const joystickCenterY = canvas.height - 20 - 120; // Centro del joystick (bottom + height/2)
        const maxDistance = 120; // Radio del joystick

        joystick.addEventListener('touchstart', (e) => {
            e.preventDefault();
            joystickActive = true;
            handleJoystick(e.touches[0]);
        });

        joystick.addEventListener('touchmove', (e) => {
            e.preventDefault();
            if (joystickActive) handleJoystick(e.touches[0]);
        });

        joystick.addEventListener('touchend', (e) => {
            e.preventDefault();
            joystickActive = false;
            joystickKnob.style.left = '50%';
            joystickKnob.style.top = '50%';
            if (pepeGameStarted) {
                pepeKeys['ArrowLeft'] = false;
                pepeKeys['ArrowRight'] = false;
                pepeKeys['ArrowUp'] = false;
                pepeKeys['ArrowDown'] = false;
            } else if (pedroGameStarted) {
                pedroKeys['ArrowLeft'] = false;
                pedroKeys['ArrowRight'] = false;
                pedroKeys['ArrowUp'] = false;
                pedroKeys['ArrowDown'] = false;
            } else if (hectorGameStarted) {
                hectorKeys['ArrowLeft'] = false;
                hectorKeys['ArrowRight'] = false;
                hectorKeys['ArrowUp'] = false;
                hectorKeys['ArrowDown'] = false;
            }
        });

        function handleJoystick(touch) {
            const touchX = touch.clientX;
            const touchY = touch.clientY;
            let dx = touchX - joystickCenterX;
            let dy = touchY - joystickCenterY;
            const distance = Math.sqrt(dx * dx + dy * dy);

            if (distance > maxDistance) {
                const angle = Math.atan2(dy, dx);
                dx = maxDistance * Math.cos(angle);
                dy = maxDistance * Math.sin(angle);
            }

            const knobX = 50 + (dx / maxDistance) * 50;
            const knobY = 50 + (dy / maxDistance) * 50;
            joystickKnob.style.left = `${knobX}%`;
            joystickKnob.style.top = `${knobY}%`;

            const angle = Math.atan2(dy, dx);
            const strength = distance / maxDistance;

            if (pepeGameStarted) {
                pepeKeys['ArrowLeft'] = dx < -20;
                pepeKeys['ArrowRight'] = dx > 20;
                pepeKeys['ArrowUp'] = dy < -20;
                pepeKeys['ArrowDown'] = dy > 20;
            } else if (pedroGameStarted) {
                pedroKeys['ArrowLeft'] = dx < -20;
                pedroKeys['ArrowRight'] = dx > 20;
                pedroKeys['ArrowUp'] = dy < -20;
                pedroKeys['ArrowDown'] = dy > 20;
            } else if (hectorGameStarted) {
                hectorKeys['ArrowLeft'] = dx < -20;
                hectorKeys['ArrowRight'] = dx > 20;
                hectorKeys['ArrowUp'] = dy < -20;
                hectorKeys['ArrowDown'] = dy > 20;
            }
        }

        fireButton.addEventListener('touchstart', (e) => {
            e.preventDefault();
            if (pepeGameStarted) pepeKeys['Space'] = true;
            else if (pedroGameStarted) pedroKeys['Space'] = true;
            else if (hectorGameStarted) hectorKeys['Space'] = true;
        });
        fireButton.addEventListener('touchend', (e) => {
            e.preventDefault();
            if (pepeGameStarted) pepeKeys['Space'] = false;
            else if (pedroGameStarted) pedroKeys['Space'] = false;
            else if (hectorGameStarted) hectorKeys['Space'] = false;
        });

        // Carga de imágenes
        Promise.all([
            new Promise(resolve => { pepeAssets.ship.onload = resolve; pepeAssets.ship.onerror = () => console.error("Error cargando pepe.png"); }),
            new Promise(resolve => { pepeAssets.bullet.onload = resolve; pepeAssets.bullet.onerror = () => console.error("Error cargando croissant_pepe.png"); }),
            new Promise(resolve => { pepeAssets.asteroid.onload = resolve; pepeAssets.asteroid.onerror = () => console.error("Error cargando uk_pepe.jpg"); }),
            new Promise(resolve => { pedroAssets.ship.onload = resolve; pedroAssets.ship.onerror = () => console.error("Error cargando pedro.png"); }),
            new Promise(resolve => { pedroAssets.bullet.onload = resolve; pedroAssets.bullet.onerror = () => console.error("Error cargando croissant_pedro.png"); }),
            new Promise(resolve => { pedroAssets.asteroid.onload = resolve; pepeAssets.asteroid.onerror = () => console.error("Error cargando uk_pedro.png"); }),
            new Promise(resolve => { hectorAssets.ship.onload = resolve; hectorAssets.ship.onerror = () => console.error("Error cargando hector.png"); }),
            new Promise(resolve => { hectorAssets.bullet.onload = resolve; hectorAssets.bullet.onerror = () => console.error("Error cargando croissant_hector.png"); }),
            new Promise(resolve => { hectorAssets.asteroid.onload = resolve; hectorAssets.asteroid.onerror = () => console.error("Error cargando uk_hector.png"); })
        ]).then(() => {
            console.log("Imágenes cargadas, listo para iniciar.");
        }).catch(error => {
            console.error("Error al cargar imágenes:", error);
        });

        window.addEventListener('resize', () => {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            if (pepeGameStarted) {
                pepeShip.x = canvas.width / 2;
                pepeShip.y = canvas.height / 2;
            } else if (pedroGameStarted) {
                pedroShip.x = canvas.width / 2;
                pedroShip.y = canvas.height / 2;
            } else if (hectorGameStarted) {
                hectorShip.x = canvas.width / 2;
                hectorShip.y = canvas.height / 2;
            }
            pepeGradient.addColorStop(0, 'blue');
            pepeGradient.addColorStop(0.5, 'white');
            pepeGradient.addColorStop(1, 'red');
            pedroGradient.addColorStop(0, '#d3d3d3');
            pedroGradient.addColorStop(0.5, '#e0e0e0');
            pedroGradient.addColorStop(1, '#c0c0c0');
            hectorGradient.addColorStop(0, 'yellow');
            hectorGradient.addColorStop(0.25, 'red');
            hectorGradient.addColorStop(0.5, 'yellow');
            hectorGradient.addColorStop(0.75, 'red');
            hectorGradient.addColorStop(1, 'yellow');
        });

        console.log("Script cargado completamente");
    </script>
</body>
</html>
