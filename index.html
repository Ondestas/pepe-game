<!DOCTYPE html>
<html>
<head>
    <title>PEPEGAME</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background: linear-gradient(45deg, blue, white, red);
        }
        canvas {
            width: 100vw;
            height: 100vh;
            display: none;
        }
        #startScreen, #endScreen, #nameScreen {
            position: absolute;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            font-family: 'Press Start 2P', cursive;
        }
        #startScreen { display: flex; }
        #endScreen, #nameScreen { display: none; }
        #startButton, #submitScore {
            padding: 20px 40px;
            font-size: 24px;
            background-color: #4CAF50;
            border: none;
            color: white;
            cursor: pointer;
            border-radius: 5px;
            transition: background-color 0.3s;
            font-family: 'Press Start 2P', cursive;
        }
        #startButton:hover, #submitScore:hover {
            background-color: #45a049;
        }
        #nameInput {
            margin: 20px;
            padding: 10px;
            font-size: 20px;
            font-family: 'Press Start 2P', cursive;
        }
        #ranking, #controls {
            margin-top: 20px;
            text-align: center;
        }
        #nextArrow {
            font-size: 36px;
            cursor: pointer;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <canvas id="gameCanvas"></canvas>
    <div id="startScreen">
        <h1>PEPEGAME</h1>
        <button id="startButton">Comenzag</button>
        <div id="controls">
            <p>Controles:</p>
            <p>Flecha Izquierda: Girar izquierda</p>
            <p>Flecha Derecha: Girar derecha</p>
            <p>Flecha Arriba: Avanzar</p>
            <p>Flecha Abajo: Retroceder</p>
            <p>Espacio: Disparar</p>
        </div>
    </div>
    <div id="endScreen">
        <h1>Se tegminó, o la la</h1>
        <p id="scoreText"></p>
        <div id="nextArrow">↓</div>
    </div>
    <div id="nameScreen">
        <h2>Introduce tu nombre</h2>
        <input type="text" id="nameInput" placeholder="Tu nombre" maxlength="10">
        <button id="submitScore">Enviar</button>
        <div id="ranking"></div>
    </div>
    <audio id="backgroundMusic" loop>
        <source src="musica.mp3" type="audio/mp3">
    </audio>
    <audio id="hitSound">
        <source src="tos.mp3" type="audio/mp3">
    </audio>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js"></script>

    <script>
        // Configuración de Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBKgK9OwzGD947pTuXSkf4bEJ70HqGL0Ck",
            authDomain: "pepegame-763c5.firebaseapp.com",
            databaseURL: "https://pepegame-763c5-default-rtdb.firebaseio.com",
            projectId: "pepegame-763c5",
            storageBucket: "pepegame-763c5.firebasestorage.app",
            messagingSenderId: "1084351604949",
            appId: "1:1084351604949:web:cd425714b9b2b825295a5c",
            measurementId: "G-3CFG6X9K0E"
        };

        // Inicializar Firebase con manejo de errores
        let db;
        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.database();
            console.log("Firebase inicializado correctamente");
        } catch (error) {
            console.error("Error al inicializar Firebase:", error);
            db = null; // Seguimos sin Firebase si falla
        }

        // Elementos del DOM
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const backgroundMusic = document.getElementById('backgroundMusic');
        const hitSound = document.getElementById('hitSound');
        const startScreen = document.getElementById('startScreen');
        const endScreen = document.getElementById('endScreen');
        const nameScreen = document.getElementById('nameScreen');
        const startButton = document.getElementById('startButton');
        const submitScore = document.getElementById('submitScore');
        const nameInput = document.getElementById('nameInput');
        const scoreText = document.getElementById('scoreText');
        const ranking = document.getElementById('ranking');
        const nextArrow = document.getElementById('nextArrow');

        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        // Imágenes
        const pepeImg = new Image();
        pepeImg.src = 'pepe.png';
        const croissantImg = new Image();
        croissantImg.src = 'croissant.png';
        const ukImg = new Image();
        ukImg.src = 'uk.jpg';

        backgroundMusic.loop = true;
        backgroundMusic.volume = 0.5;

        let gameStarted = false;
        let lastShotTime = 0;

        class Ship {
            constructor() {
                this.x = canvas.width / 2;
                this.y = canvas.height / 2;
                this.angle = 0;
                this.speed = 0;
                this.width = 80;
                this.height = 80;
            }

            draw() {
                ctx.save();
                ctx.translate(this.x, this.y);
                ctx.rotate(this.angle);
                ctx.drawImage(pepeImg, -this.width/2, -this.height/2, this.width, this.height);
                ctx.restore();
            }

            update() {
                this.x += Math.cos(this.angle) * this.speed;
                this.y += Math.sin(this.angle) * this.speed;
                if (this.x < 0) this.x = canvas.width;
                if (this.x > canvas.width) this.x = 0;
                if (this.y < 0) this.y = canvas.height;
                if (this.y > canvas.height) this.y = 0;
            }
        }

        class Bullet {
            constructor(x, y, angle) {
                this.x = x;
                this.y = y;
                this.angle = angle;
                this.speed = 10;
                this.width = 60;
                this.height = 60;
            }

            draw() {
                ctx.save();
                ctx.translate(this.x, this.y);
                ctx.rotate(this.angle);
                ctx.drawImage(croissantImg, -this.width/2, -this.height/2, this.width, this.height);
                ctx.restore();
            }

            update() {
                this.x += Math.cos(this.angle) * this.speed;
                this.y += Math.sin(this.angle) * this.speed;
            }
        }

        class Asteroid {
            constructor() {
                this.x = Math.random() * canvas.width;
                this.y = Math.random() * canvas.height;
                this.speedX = (Math.random() - 0.5) * 4;
                this.speedY = (Math.random() - 0.5) * 4;
                this.width = 50;
                this.height = 50;
            }

            draw() {
                ctx.drawImage(ukImg, this.x - this.width/2, this.y - this.height/2, this.width, this.height);
            }

            update() {
                this.x += this.speedX;
                this.y += this.speedY;
                if (this.x < 0) this.x = canvas.width;
                if (this.x > canvas.width) this.x = 0;
                if (this.y < 0) this.y = canvas.height;
                if (this.y > canvas.height) this.y = 0;
            }
        }

        const ship = new Ship();
        let bullets = [];
        let asteroids = [];
        const maxAsteroids = 5;
        let lives = 3;
        let score = 0;
        let timeLeft = 60;
        let lastTime = Date.now();

        let keys = {};
        document.addEventListener('keydown', (e) => { keys[e.code] = true; });
        document.addEventListener('keyup', (e) => { keys[e.code] = false; });

        for (let i = 0; i < maxAsteroids; i++) {
            asteroids.push(new Asteroid());
        }

        function createExplosion(x, y) {
            for (let i = 0; i < 20; i++) {
                ctx.fillStyle = `hsl(${Math.random() * 360}, 100%, 50%)`;
                ctx.beginPath();
                ctx.arc(
                    x + (Math.random() - 0.5) * 30,
                    y + (Math.random() - 0.5) * 30,
                    Math.random() * 3,
                    0,
                    Math.PI * 2
                );
                ctx.fill();
            }
        }

        function drawLives() {
            const lifeSize = 80;
            ctx.fillStyle = 'black';
            ctx.fillRect(canvas.width - 300, canvas.height - lifeSize - 40, 280, 30);
            ctx.fillStyle = 'yellow';
            ctx.font = '16px "Press Start 2P"';
            ctx.textAlign = 'right';
            ctx.fillText('Vidas ghestantes', canvas.width - 10, canvas.height - lifeSize - 15);

            for (let i = 0; i < lives; i++) {
                ctx.drawImage(
                    croissantImg,
                    canvas.width - (lifeSize + 10) * (i + 1),
                    canvas.height - lifeSize - 10,
                    lifeSize,
                    lifeSize
                );
            }
        }

        function drawHUD() {
            ctx.font = '16px "Press Start 2P"';
            ctx.textAlign = 'left';

            const puntosText = `Puntos: ${score}`;
            const puntosWidth = ctx.measureText(puntosText).width;
            ctx.fillStyle = 'black';
            ctx.fillRect(10, 10, puntosWidth + 20, 30);

            const tiempoText = `Tiempo ghestante: ${Math.ceil(timeLeft)}`;
            const tiempoWidth = ctx.measureText(tiempoText).width;
            ctx.fillStyle = 'black';
            ctx.fillRect(10, 40, tiempoWidth + 20, 30);

            ctx.fillStyle = 'yellow';
            ctx.fillText(puntosText, 20, 30);
            ctx.fillText(tiempoText, 20, 60);
        }

        function saveScore(name, score) {
            if (db) {
                const newScore = { name, score, timestamp: Date.now() };
                db.ref('scores').push(newScore).then(() => {
                    console.log("Puntuación guardada:", newScore);
                }).catch(error => {
                    console.error("Error al guardar puntuación:", error);
                });
            } else {
                console.warn("Firebase no disponible, puntuación no guardada");
            }
        }

        function loadAndShowRanking() {
            if (db) {
                db.ref('scores').orderByChild('score').limitToLast(5).once('value', (snapshot) => {
                    const scores = [];
                    snapshot.forEach(child => {
                        scores.push(child.val());
                    });
                    scores.sort((a, b) => b.score - a.score);
                    showRanking(scores);
                }).catch(error => {
                    console.error("Error al cargar ranking:", error);
                    ranking.innerHTML = '<h2>Ranking</h2><p>Error al cargar</p>';
                });
            } else {
                ranking.innerHTML = '<h2>Ranking</h2><p>Firebase no disponible</p>';
            }
        }

        function showRanking(scores) {
            ranking.innerHTML = '<h2>Ranking</h2>' + scores.map((s, i) => 
                `<p>${i + 1}. ${s.name}: ${s.score}</p>`).join('');
        }

        function showGameOver() {
            gameStarted = false;
            canvas.style.display = 'none';
            endScreen.style.display = 'flex';
            scoreText.textContent = `Has ghoto: ${score}`;
        }

        function showNameScreen() {
            endScreen.style.display = 'none';
            nameScreen.style.display = 'flex';
            nameInput.value = '';
            ranking.innerHTML = '';
            loadAndShowRanking();
        }

        function gameLoop() {
            if (!gameStarted) return;

            const currentTime = Date.now();
            const deltaTime = (currentTime - lastTime) / 1000;
            lastTime = currentTime;

            timeLeft -= deltaTime;
            if (timeLeft <= 0) {
                showGameOver();
                return;
            }

            ctx.clearRect(0, 0, canvas.width, canvas.height);

            if (keys['ArrowLeft']) ship.angle -= 0.1;
            if (keys['ArrowRight']) ship.angle += 0.1;
            if (keys['ArrowUp']) ship.speed = 5;
            if (keys['ArrowDown']) ship.speed = -5;
            if (!keys['ArrowUp'] && !keys['ArrowDown']) ship.speed = 0;
            if (keys['Space'] && !keys['spacePressed'] && (currentTime - lastShotTime) >= 500) {
                bullets.push(new Bullet(ship.x, ship.y, ship.angle));
                keys['spacePressed'] = true;
                lastShotTime = currentTime;
            }
            if (!keys['Space']) keys['spacePressed'] = false;

            ship.update();
            ship.draw();

            bullets = bullets.filter(b => 
                b.x > 0 && b.x < canvas.width && 
                b.y > 0 && b.y < canvas.height
            );
            bullets.forEach(b => {
                b.update();
                b.draw();
            });

            asteroids.forEach((a, aIndex) => {
                a.update();
                a.draw();

                bullets.forEach((b, bIndex) => {
                    if (Math.hypot(a.x - b.x, a.y - b.y) < a.width/2 + b.width/2) {
                        hitSound.play();
                        createExplosion(a.x, a.y);
                        asteroids.splice(aIndex, 1);
                        bullets.splice(bIndex, 1);
                        asteroids.push(new Asteroid());
                        score += 1;
                    }
                });

                if (Math.hypot(a.x - ship.x, a.y - ship.y) < a.width/2 + ship.width/2) {
                    lives -= 1;
                    hitSound.play();
                    createExplosion(ship.x, ship.y);
                    ship.x = canvas.width / 2;
                    ship.y = canvas.height / 2;
                    ship.speed = 0;
                    ship.angle = 0;
                    asteroids.splice(aIndex, 1);
                    asteroids.push(new Asteroid());
                    if (lives <= 0) {
                        showGameOver();
                        return;
                    }
                }
            });

            drawLives();
            drawHUD();

            requestAnimationFrame(gameLoop);
        }

        function startGame() {
            console.log("Botón 'Comenzag' clicado, iniciando juego...");
            gameStarted = true;
            startScreen.style.display = 'none';
            canvas.style.display = 'block';
            backgroundMusic.play().catch(error => {
                console.log("Error al reproducir música:", error);
            });
            lastTime = Date.now();
            gameLoop();
        }

        // Registro de eventos al inicio
        console.log("Registrando eventos...");
        startButton.addEventListener('click', () => {
            console.log("Evento click disparado en startButton");
            startGame();
        });
        nextArrow.addEventListener('click', () => {
            console.log("Evento click disparado en nextArrow");
            showNameScreen();
        });
        submitScore.addEventListener('click', () => {
            console.log("Evento click disparado en submitScore");
            const name = nameInput.value.trim();
            if (name) {
                saveScore(name, score);
                setTimeout(() => {
                    loadAndShowRanking();
                    setTimeout(() => {
                        nameScreen.style.display = 'none';
                        startScreen.style.display = 'flex';
                        lives = 3;
                        score = 0;
                        timeLeft = 60;
                        ship.x = canvas.width / 2;
                        ship.y = canvas.height / 2;
                        bullets = [];
                        asteroids = [];
                        for (let i = 0; i < maxAsteroids; i++) {
                            asteroids.push(new Asteroid());
                        }
                    }, 2000);
                }, 500);
            }
        });

        // Carga de imágenes con espera explícita
        Promise.all([
            new Promise(resolve => { pepeImg.onload = resolve; pepeImg.onerror = () => console.error("Error cargando pepe.png"); }),
            new Promise(resolve => { croissantImg.onload = resolve; croissantImg.onerror = () => console.error("Error cargando croissant.png"); }),
            new Promise(resolve => { ukImg.onload = resolve; ukImg.onerror = () => console.error("Error cargando uk.jpg"); })
        ]).then(() => {
            console.log("Imágenes cargadas, listo para iniciar.");
        }).catch(error => {
            console.error("Error al cargar imágenes:", error);
        });

        window.addEventListener('resize', () => {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            ship.x = canvas.width / 2;
            ship.y = canvas.height / 2;
        });

        console.log("Script cargado completamente");
    </script>
</body>
</html>
